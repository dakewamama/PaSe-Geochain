"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};function e(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}var n=function(){return n=Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var a in e=arguments[n])Object.prototype.hasOwnProperty.call(e,a)&&(t[a]=e[a]);return t},n.apply(this,arguments)};function r(t,e,n,r){return new(n||(n=Promise))((function(a,o){function i(t){try{u(r.next(t))}catch(t){o(t)}}function s(t){try{u(r.throw(t))}catch(t){o(t)}}function u(t){var e;t.done?a(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(i,s)}u((r=r.apply(t,e||[])).next())}))}function a(t,e){var n,r,a,o,i={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return o={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function s(s){return function(u){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;o&&(o=0,s[0]&&(i=0)),i;)try{if(n=1,r&&(a=2&s[0]?r.return:s[0]?r.throw||((a=r.return)&&a.call(r),0):r.next)&&!(a=a.call(r,s[1])).done)return a;switch(r=0,a&&(s=[2&s[0],a.value]),s[0]){case 0:case 1:a=s;break;case 4:return i.label++,{value:s[1],done:!1};case 5:i.label++,r=s[1],s=[0];continue;case 7:s=i.ops.pop(),i.trys.pop();continue;default:if(!(a=i.trys,(a=a.length>0&&a[a.length-1])||6!==s[0]&&2!==s[0])){i=0;continue}if(3===s[0]&&(!a||s[1]>a[0]&&s[1]<a[3])){i.label=s[1];break}if(6===s[0]&&i.label<a[1]){i.label=a[1],a=s;break}if(a&&i.label<a[2]){i.label=a[2],i.ops.push(s);break}a[2]&&i.ops.pop(),i.trys.pop();continue}s=e.call(t,i)}catch(t){s=[6,t],r=0}finally{n=a=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,u])}}}function o(t,e,n){if(n||2===arguments.length)for(var r,a=0,o=e.length;a<o;a++)!r&&a in e||(r||(r=Array.prototype.slice.call(e,0,a)),r[a]=e[a]);return t.concat(r||Array.prototype.slice.call(e))}function i(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}function s(t){return Number.isInteger(t)&&t>=0}function u(t){this.name="ArgumentError",this.message=t}"function"==typeof SuppressedError&&SuppressedError;var E,d=i((function(t,e){if(e=e||{},"function"!=typeof t)throw new u("fetch must be a function");if("object"!=typeof e)throw new u("defaults must be an object");if(void 0!==e.retries&&!s(e.retries))throw new u("retries must be a positive integer");if(void 0!==e.retryDelay&&!s(e.retryDelay)&&"function"!=typeof e.retryDelay)throw new u("retryDelay must be a positive integer or a function returning a positive integer");if(void 0!==e.retryOn&&!Array.isArray(e.retryOn)&&"function"!=typeof e.retryOn)throw new u("retryOn property expects an array or function");return e=Object.assign({retries:3,retryDelay:1e3,retryOn:[]},e),function(n,r){var a=e.retries,o=e.retryDelay,i=e.retryOn;if(r&&void 0!==r.retries){if(!s(r.retries))throw new u("retries must be a positive integer");a=r.retries}if(r&&void 0!==r.retryDelay){if(!s(r.retryDelay)&&"function"!=typeof r.retryDelay)throw new u("retryDelay must be a positive integer or a function returning a positive integer");o=r.retryDelay}if(r&&r.retryOn){if(!Array.isArray(r.retryOn)&&"function"!=typeof r.retryOn)throw new u("retryOn property expects an array or function");i=r.retryOn}return new Promise((function(e,s){var u=function(o){var u="undefined"!=typeof Request&&n instanceof Request?n.clone():n;t(u,r).then((function(t){if(Array.isArray(i)&&-1===i.indexOf(t.status))e(t);else if("function"==typeof i)try{return Promise.resolve(i(o,null,t)).then((function(n){n?E(o,null,t):e(t)})).catch(s)}catch(t){s(t)}else o<a?E(o,null,t):e(t)})).catch((function(t){if("function"==typeof i)try{Promise.resolve(i(o,t,null)).then((function(e){e?E(o,t,null):s(t)})).catch((function(t){s(t)}))}catch(t){s(t)}else o<a?E(o,t,null):s(t)}))};function E(t,e,n){var r="function"==typeof o?o(t,e,n):o;setTimeout((function(){u(++t)}),r)}u(0)}))}})),c=function(t){return t?Object.entries(t).reduce((function(t,e){var r,a=e[0],o=e[1];return null==o||o instanceof Array&&0===o.length||o instanceof Object&&0===Object.keys(o).length||""===o?t:n(n({},t),((r={})[a]=o.toString(),r))}),{}):{}};!function(t){t.DEBUG="debug",t.INFO="info",t.WARN="warn",t.ERROR="error"}(E||(E={}));var l,S=[E.DEBUG,E.INFO,E.WARN,E.ERROR],p=function(t,e){return S.indexOf(e)>=S.indexOf(t)},_=E.INFO,R=function(){function t(t,e){void 0===e&&(e=_),this.logger=t,this.logLevel=e}return t.prototype.setLogLevel=function(t){this.logLevel=t},t.prototype.debug=function(t,e){p(this.logLevel,E.DEBUG)&&this.logger.debug(t,e)},t.prototype.info=function(t,e){p(this.logLevel,E.INFO)&&this.logger.info(t,e)},t.prototype.warn=function(t,e){p(this.logLevel,E.WARN)&&this.logger.warn(t,e)},t.prototype.error=function(t,e){p(this.logLevel,E.ERROR)&&this.logger.error(t,e)},t}(),T=function(t,e,n){n?t(e,n):t(e)},N=new R(new(function(t){function n(e){return void 0===e&&(e=_),t.call(this,console,e)||this}return e(n,t),n.prototype.setLogLevel=function(t){this.logLevel=t},n.prototype.debug=function(t,e){T(this.logger.debug,t,e)},n.prototype.info=function(t,e){T(this.logger.info,t,e)},n.prototype.warn=function(t,e){T(this.logger.warn,t,e)},n.prototype.error=function(t,e){T(this.logger.error,t,e)},n}(R))),I=function(t,e){return function(n,r){return void 0===r&&(r=null),N.debug("[".concat(e,"][").concat(t,"] ").concat(n),r)}},v=function(t,e){return function(n,r){return void 0===r&&(r=null),N.error("[".concat(e,"][").concat(t,"] ").concat(n),r)}},A=function(t,e){return function(n,r){return void 0===r&&(r=null),N.warn("[".concat(e,"][").concat(t,"] ").concat(n),r)}},f=function(t,e){return function(n,r){return void 0===r&&(r=null),N.info("[".concat(e,"][").concat(t,"] ").concat(n),r)}},y=function(t,e){return void 0===e&&(e="GatewayClientCore"),{setLogLevel:function(t){var e;return null===(e=null==N?void 0:N.setLogLevel)||void 0===e?void 0:e.call(N,t)},debug:I(t,e),error:v(t,e),warn:A(t,e),info:f(t,e)}};!function(t){t[t.REQUESTING=0]="REQUESTING",t[t.NOT_REQUESTED=404]="NOT_REQUESTED",t[t.REQUESTED=202]="REQUESTED",t[t.ISSUED=200]="ISSUED",t[t.ISSUED_EXPIRY_APPROACHING=205]="ISSUED_EXPIRY_APPROACHING",t[t.ISSUED_EXPIRED=426]="ISSUED_EXPIRED",t[t.LOCATION_NOT_SUPPORTED=401]="LOCATION_NOT_SUPPORTED",t[t.REJECTED=403]="REJECTED",t[t.VPN_NOT_SUPPORTED=421]="VPN_NOT_SUPPORTED",t[t.ISSUED_LOCATION_NOT_SUPPORTED=412]="ISSUED_LOCATION_NOT_SUPPORTED",t[t.ISSUED_VPN_NOT_SUPPORTED=451]="ISSUED_VPN_NOT_SUPPORTED",t[t.SERVER_FAILURE=500]="SERVER_FAILURE",t[t.REQUESTED_RETRIES_EXHAUSTED=408]="REQUESTED_RETRIES_EXHAUSTED"}(l||(l={}));var h,O,w,C,g={local:"http://localhost:3001/local",test:"https://dev-gatekeeper-api.civic.com",dev:"https://dev-gatekeeper-api.civic.com",preprod:"https://preprod-gatekeeper-api.civic.com",prod:"https://gatekeeper-api.civic.com"},x=y("GatekeeperClient").debug,G=y("GatekeeperClient").warn,D=y("GatekeeperClient").error,m=function(t,e){var n=g[t];return n||(G("No Gatekeeper endpoint for stage ".concat(t," . Using dev endpoint.")),n=g.dev),"".concat(n,"/v1/token/").concat(e)},U=function(t){return Object.fromEntries(Object.entries(t).filter((function(t){return void 0!==t[1]})))},b=function(){function t(t,e){var o=this;this.initConfig=t,this.abortController=t.abortController,this.baseUrl=t.baseUrl||m(t.stage,t.chainType),this.queryParams=t.queryParams,this.headers=c(n(n({},t.headers),{"x-civic-flowid":e})),this.fetchImplementation=t.fetchImplementation;var i=t.numRetries;this.defaultRetryParams={retries:i,retryOn:function(t,e,n){return r(o,void 0,void 0,(function(){var r,o,s;return a(this,(function(a){switch(a.label){case 0:return n?[4,n.clone().json()]:[3,2];case 1:return o=a.sent(),[3,3];case 2:o={},a.label=3;case 3:if(r=o,n&&n.status>=500){if(null===(s=null==r?void 0:r.message)||void 0===s?void 0:s.includes("NO_AUTO_RETRY"))return[2,!1];if(t>=i)throw D("retryOn error run out of retries",{error:e,attempt:t,retries:i,response:n,body:r}),e;return x("retrying on 5xx error",{error:e,attempt:t,retries:i,response:n,body:r}),[2,!0]}return x("retryOn returning false as error was not a 5xx error"),[2,!1]}}))}))},retryDelay:function(t){var e=10+1e3*Math.pow(2,t);return x("retryDelay",{attempt:t+1,retryDelay:e}),e}},this.fetchWithRetry=d(this.fetchImplementation,this.defaultRetryParams)}return t.prototype.setFlowId=function(t){this.headers=c(n(n({},this.headers||{}),{"x-civic-flowid":t}))},t.prototype.instanceName=function(){var t,e;return null===(e=null===(t=this.queryParams)||void 0===t?void 0:t.gatekeeperNetworkAddress)||void 0===e?void 0:e.substring(0,6)},t.prototype.abort=function(){var t,e;x("abort ".concat(null===(e=null===(t=this.queryParams)||void 0===t?void 0:t.gatekeeperNetworkAddress)||void 0===e?void 0:e.substring(0,6))),this.abortController.abort()},t.prototype.addQueryParams=function(t){this.queryParams&&Object.entries(this.queryParams).forEach((function(e){var n=e[0],r=e[1];t.searchParams.append(n,r)}))},t.prototype.continueIfNotAborted=function(t){return x("continueIfNotAborted ".concat(this.instanceName()," this.abortController.signal.aborted: ").concat(this.abortController.signal.aborted),this.queryParams),this.abortController.signal.aborted?null:t()},t.prototype.urlForWallet=function(t){void 0===t&&(t=this.initConfig.walletAddress);var e=new URL("".concat(this.baseUrl,"/").concat(t));return this.addQueryParams(e),e.toString()},t.prototype.getGatekeeperRecordWithPayload=function(){return r(this,arguments,void 0,(function(t){var e=this;return void 0===t&&(t=this.initConfig.walletAddress),a(this,(function(n){return x("url: ".concat(this.urlForWallet(t)," getGatekeeperRecordWithPayload: ").concat(this.instanceName(),"  this.abortController.signal.aborted: ").concat(this.abortController.signal.aborted)),[2,this.fetchWithRetry(this.urlForWallet(t),{method:"GET",headers:this.headers,signal:this.abortController.signal}).then(this.continueIfNotAborted((function(){return function(t){return r(e,void 0,void 0,(function(){var e;return a(this,(function(n){switch(n.label){case 0:return e={state:l[l[t.status]]},[4,t.json()];case 1:return[2,(e.payload=n.sent(),e)]}}))}))}}))).catch((function(t){if("AbortError"===t.name)return x("error due to abort controller signal aborted"),null;throw t}))]}))}))},t.prototype.getGatekeeperStatus=function(){return r(this,arguments,void 0,(function(t){return void 0===t&&(t=this.initConfig.walletAddress),a(this,(function(e){return x("getGatekeeperStatus: ".concat(this.instanceName(),"  this.abortController.signal.aborted: ").concat(this.abortController.signal.aborted)),[2,this.fetchWithRetry(this.urlForWallet(t),{method:"HEAD",headers:this.headers,signal:this.abortController.signal}).then(this.continueIfNotAborted((function(){return function(t){return t.status}}))).catch((function(t){if(D("getGatekeeperStatus",t),"AbortError"===t.name)return x("error due to abort controller signal aborted"),l.SERVER_FAILURE;throw t}))]}))}))},t.prototype.requestGatewayTokenFromGatekeeper=function(t){return r(this,arguments,void 0,(function(t){var e,o,i=this,s=t.payload,u=t.proof,E=t.payer;return a(this,(function(t){return x("requestGatewayTokenFromGatekeeper: ".concat(this.instanceName(),"  this.abortController.signal.aborted: ").concat(this.abortController.signal.aborted),n(n({},s),{proof:u})),e=U(n(n({},s),{proof:u,address:this.initConfig.walletAddress,payer:E})),x("requestGatewayTokenFromGatekeeper Requesting a new gatekeeper token...",e),o=new URL(this.baseUrl),this.addQueryParams(o),[2,this.fetchWithRetry(o.toString(),{method:"POST",headers:n(n({},this.headers),{"Content-Type":"application/json"}),body:JSON.stringify(e),signal:this.abortController.signal}).then(this.continueIfNotAborted((function(){return function(t){return r(i,void 0,void 0,(function(){var e,r;return a(this,(function(a){switch(a.label){case 0:return e=t.status,[4,t.json()];case 1:return r=a.sent(),[2,n(n({},r),{state:l[l[e]],status:e})]}}))}))}}))).catch((function(t){if(D("requestGatewayTokenFromGatekeeper",t),"AbortError"===t.name)return x("error due to abort controller signal aborted"),null;throw t}))]}))}))},t.prototype.refreshToken=function(t){return r(this,arguments,void 0,(function(t){var e,o,i,s=this,u=t.payload,E=t.proof,d=t.payer;return a(this,(function(t){return x("refreshToken: ".concat(this.urlForWallet(this.initConfig.walletAddress)).concat(null===(i=null===(o=this.queryParams)||void 0===o?void 0:o.gatekeeperNetworkAddress)||void 0===i?void 0:i.substring(0,6),"  this.abortController.signal.aborted: ").concat(this.abortController.signal.aborted),{payload:u}),e=U(n(n({},u),{proof:E,request:"refresh",payer:d})),[2,this.fetchWithRetry(this.urlForWallet(this.initConfig.walletAddress),{method:"PATCH",headers:n(n({},this.headers),{"Content-Type":"application/json"}),body:JSON.stringify(e),signal:this.abortController.signal}).then((function(t){return r(s,void 0,void 0,(function(){var e,r;return a(this,(function(a){switch(a.label){case 0:return e=t.status,[4,t.json()];case 1:return r=a.sent(),[2,n(n({},r),{state:l[l[e]],status:e})]}}))}))})).catch((function(t){if(D("refreshToken",t),"AbortError"===t.name)return x("error due to abort controller signal aborted"),null;throw t}))]}))}))},t.prototype.fetchFreshTransaction=function(t){return r(this,arguments,void 0,(function(t){var e,o,i,s,u=this,E=t.payer;return a(this,(function(t){return e=new URL("".concat(this.baseUrl,"/").concat(this.initConfig.walletAddress,"/transaction")),this.addQueryParams(e),x("fetchFreshTransaction: ".concat(e.toString()).concat(null===(s=null===(i=this.queryParams)||void 0===i?void 0:i.gatekeeperNetworkAddress)||void 0===s?void 0:s.substring(0,6),"  this.abortController.signal.aborted: ").concat(this.abortController.signal.aborted)),o=U({payer:E}),[2,this.fetchWithRetry("".concat(e.toString()),{method:"POST",headers:n(n({},this.headers),{"Content-Type":"application/json"}),body:JSON.stringify(o),signal:this.abortController.signal}).then((function(t){return r(u,void 0,void 0,(function(){var e,r;return a(this,(function(a){switch(a.label){case 0:return e=t.status,[4,t.json()];case 1:return r=a.sent(),[2,n(n({},r),{state:l[l[e]],status:e})]}}))}))})).catch((function(t){if(D("fetchFreshTransaction",t),"AbortError"===t.name)return x("error due to abort controller signal aborted"),null;throw t}))]}))}))},t.prototype.updateTransactionStatus=function(t){return r(this,arguments,void 0,(function(t,e){var o,i,s=this;return void 0===e&&(e="sent"),a(this,(function(u){return o=new URL("".concat(this.baseUrl,"/").concat(this.initConfig.walletAddress,"/transaction/").concat(t)),this.addQueryParams(o),i={status:e},[2,this.fetchWithRetry(o.toString(),{method:"PATCH",headers:n(n({},this.headers),{"Content-Type":"application/json"}),body:JSON.stringify(i),signal:this.abortController.signal}).then(this.continueIfNotAborted((function(){return function(){return r(s,void 0,void 0,(function(){return a(this,(function(e){return x("updateTransactionStatus successful",{txId:t,url:o,wallet:this.initConfig.walletAddress}),[2]}))}))}}))).catch((function(t){if("AbortError"===t.name)return x("error due to abort controller signal aborted"),null;throw D("updateTransactionStatus",t),t}))]}))}))},t}();exports.State=void 0,(h=exports.State||(exports.State={})).ACTIVE="ACTIVE",h.REVOKED="REVOKED",h.FROZEN="FROZEN",exports.TokenState=void 0,(O=exports.TokenState||(exports.TokenState={})).REQUESTED="REQUESTED",O.ACTIVE="ACTIVE",O.REVOKED="REVOKED",O.FROZEN="FROZEN",O.REJECTED="REJECTED",exports.ChainType=void 0,(w=exports.ChainType||(exports.ChainType={})).SOLANA="solana",w.ETHEREUM="ethereum",w.CASPER="casper",w.ICP="icp",exports.SignatureMethod=void 0,(C=exports.SignatureMethod||(exports.SignatureMethod={}))[C.TRANSACTION=0]="TRANSACTION",C[C.MESSAGE=1]="MESSAGE";var P,F,k={INSUFFICIENT_FUNDS:"0x1",SIGN_TRANSACTION_ERROR:"0x2",SIGN_TRANSACTION_USER_REJECTED_ERROR:"0x21",SIGN_TRANSACTION_UNKNOWN_ERROR:"0x22",SEND_TRANSACTION_ERROR:"0x3",CUSTOM_HANDLE_TRANSACTION_ERROR:"0x4",POWO_ERROR:"0x5",CHAIN_CONFIRMATION_TIMEOUT_ERROR:"0x6",TRANSACTION_FAILED_ON_CHAIN_ERROR:"0x61",TRANSACTION_DROPPED_ERROR:"0x62",TRANSACTION_CONFIRMATION_UNKNOWN_ERROR:"0x63",BROWSER_CLOSED_WHILE_TRANSACTION_PENDING:"0x64",EXPECTED_GATEKEEPER_RECORD:"0x7"},L=function(t){function n(e,r,a){void 0===a&&(a=N);var o=t.call(this,e)||this;return o.errorCode=r,null==a||a.error("ChainError: ".concat(e," throwing code ").concat(r)),Object.setPrototypeOf(o,n.prototype),o}return e(n,t),n}(Error),H=function(t){function n(e,r){void 0===r&&(r=k.CHAIN_CONFIRMATION_TIMEOUT_ERROR);var a=t.call(this,e)||this;return a.errorCode=r,N.error("ChainConfirmationTimeout: ".concat(e," throwing code ").concat(r)),Object.setPrototypeOf(a,n.prototype),a}return e(n,t),n}(Error);exports.GatewayStatus=void 0,(P=exports.GatewayStatus||(exports.GatewayStatus={})).UNKNOWN="UNKNOWN",P.CHECKING="CHECKING",P.NOT_REQUESTED="NOT_REQUESTED",P.COLLECTING_USER_INFORMATION="COLLECTING_USER_INFORMATION",P.IN_REVIEW="IN_REVIEW",P.REJECTED="REJECTED",P.REVOKED="REVOKED",P.FROZEN="FROZEN",P.ACTIVE="ACTIVE",P.ERROR="ERROR",P.LOCATION_NOT_SUPPORTED="LOCATION_NOT_SUPPORTED",P.VPN_NOT_SUPPORTED="VPN_NOT_SUPPORTED",P.REFRESH_TOKEN_REQUIRED="REFRESH_TOKEN_REQUIRED",P.VALIDATING_USER_INFORMATION="VALIDATING_USER_INFORMATION",P.USER_INFORMATION_VALIDATED="USER_INFORMATION_VALIDATED",P.USER_INFORMATION_REJECTED="USER_INFORMATION_REJECTED",exports.ExtendedGatewayStatus=void 0,(F=exports.ExtendedGatewayStatus||(exports.ExtendedGatewayStatus={})).AWAITING_OWNER_TRANSACTION="AWAITING_OWNER_TRANSACTION",F.CHAIN_TIMEOUT_ERROR="CHAIN_TIMEOUT_ERROR",F.CONFIRM_OWNER_TRANSACTION="CONFIRM_OWNER_TRANSACTION",F.CHAIN_TRANSACTION_ERROR="CHAIN_TRANSACTION_ERROR",F.TOKEN_IN_PARTNER_REVIEW="TOKEN_IN_PARTNER_REVIEW",F.TOKEN_REFRESH_IN_REVIEW="TOKEN_REFRESH_IN_REVIEW",F.USER_VALIDATION_FAILED="USER_VALIDATION_FAILED",F.RESTART="RESTART",F.CHAIN_SIGN_MESSAGE_ERROR="CHAIN_SIGN_MESSAGE_ERROR",F.ISSUANCE_CLIENT_PAYER_REQUESTED="ISSUANCE_CLIENT_PAYER_REQUESTED",F.ISSUANCE_AWAITING_TRANSACTION_SEND="ISSUANCE_AWAITING_TRANSACTION_SEND",F.ISSUANCE_AWAITING_THIRD_PARTY_TRANSACTION_SEND="ISSUANCE_AWAITING_THIRD_PARTY_TRANSACTION_SEND",F.ISSUANCE_AWAITING_ON_CHAIN_TOKEN="ISSUANCE_AWAITING_ON_CHAIN_TOKEN",F.ISSUANCE_RESTART_DATA_COLLECTION="ISSUANCE_RESTART_DATA_COLLECTION",F.ISSUANCE_CLIENT_SENDS_REQUEST_NEW_TX="ISSUANCE_CLIENT_SENDS_REQUEST_NEW_TX",F.ISSUANCE_CLIENT_THIRD_PARTY_SENDS_REQUEST_NEW_TX="ISSUANCE_CLIENT_THIRD_PARTY_SENDS_REQUEST_NEW_TX",F.ISSUANCE_CLIENT_SENDS_START_NEW_TX="ISSUANCE_CLIENT_SENDS_START_NEW_TX",F.REFRESH_USER_INFORMATION_VALIDATED="REFRESH_USER_INFORMATION_VALIDATED",F.REFRESH_CLIENT_PAYER_REQUESTED="REFRESH_CLIENT_PAYER_REQUESTED",F.REFRESH_IN_REVIEW="REFRESH_IN_REVIEW",F.REFRESH_AWAITING_TRANSACTION_SEND="REFRESH_AWAITING_TRANSACTION_SEND",F.REFRESH_AWAITING_THIRD_PARTY_TRANSACTION_SEND="REFRESH_AWAITING_THIRD_PARTY_TRANSACTION_SEND",F.REFRESH_AWAITING_ON_CHAIN_TOKEN="REFRESH_AWAITING_ON_CHAIN_TOKEN",F.RESTART_REFRESH="RESTART_REFRESH",F.REFRESH_CLIENT_SENDS_REQUEST_NEW_TX="REFRESH_CLIENT_SENDS_REQUEST_NEW_TX",F.REFRESH_CLIENT_THIRD_PARTY_SENDS_REQUEST_NEW_TX="REFRESH_CLIENT_THIRD_PARTY_SENDS_REQUEST_NEW_TX",F.REFRESH_CLIENT_SENDS_START_NEW_TX="REFRESH_CLIENT_SENDS_START_NEW_TX";var W,M,V={local:"https://dev.api.civic.com/gkn-dev",test:"https://dev.api.civic.com/gkn-dev",dev:"https://dev.api.civic.com/gkn-dev",preprod:"https://dev.api.civic.com/gkn-preprod",prod:"https://api.civic.com/gkn"},K=function(t,e){return r(void 0,void 0,void 0,(function(){var n;return a(this,(function(r){switch(r.label){case 0:if(!V[t])throw new Error("No Gatekeeper Network Service endpoint found for stage ".concat(t));return[4,fetch("".concat(V[t],"/public/gatekeeperNetwork/").concat(e))];case 1:return[4,r.sent().json()];case 2:if((null==(n=r.sent())?void 0:n.id)!==e)throw new Error("Could not fetch data from Gatekeeper Network Service for ".concat(e));return[2,n]}}))}))};let Q;exports.FlowType=void 0,(W=exports.FlowType||(exports.FlowType={})).ISSUANCE="issuance",W.REFRESH="refresh",W.STATUS="status",W.REVOCATION="revocation",W.UNFREEZE="unfreeze",exports.FlowStatus=void 0,(M=exports.FlowStatus||(exports.FlowStatus={})).IN_PROGRESS="in-progress",M.RESULT="result",M.FINISHED="finished";const j=new Uint8Array(16);function q(){if(!Q&&(Q="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!Q))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return Q(j)}const X=[];for(let t=0;t<256;++t)X.push((t+256).toString(16).slice(1));var Y,J,z,B,Z,$={randomUUID:"undefined"!=typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};function tt(t,e,n){if($.randomUUID&&!e&&!t)return $.randomUUID();const r=(t=t||{}).random||(t.rng||q)();if(r[6]=15&r[6]|64,r[8]=63&r[8]|128,e){n=n||0;for(let t=0;t<16;++t)e[n+t]=r[t];return e}return function(t,e=0){return X[t[e+0]]+X[t[e+1]]+X[t[e+2]]+X[t[e+3]]+"-"+X[t[e+4]]+X[t[e+5]]+"-"+X[t[e+6]]+X[t[e+7]]+"-"+X[t[e+8]]+X[t[e+9]]+"-"+X[t[e+10]]+X[t[e+11]]+X[t[e+12]]+X[t[e+13]]+X[t[e+14]]+X[t[e+15]]}(r)}!function(t){t.SUCCESS="success",t.FAILURE="failure",t.CANCELLED="cancelled",t.IN_PROGRESS="inProgress",t.ERROR="error"}(Y||(Y={})),function(t){t.ISSUANCE="issuance",t.CONFIRM_TRANSACTION="confirmTransaction",t.TOKEN_FROZEN="tokenFrozen",t.TOKEN_ACTIVE="tokenActive",t.TOKEN_REVOKED="tokenRevoked",t.TOKEN_REJECTED="tokenRejected",t.TOKEN_IN_REVIEW="tokenInReview",t.TOKEN_REFRESH_IN_REVIEW="tokenRefreshInReview",t.TOKEN_IN_PARTNER_REVIEW="tokenInPartnerReview",t.FAILED_IP_CHECK="failedIpCheck",t.FAILED_VPN_CHECK="failedVpnCheck",t.REFRESH="refresh",t.STATUS="status",t.ERROR="error",t.CHAIN_ERROR="chainError",t.SIGN_TRANSACTION="signTransaction",t.AWAITING_TRANSACTION_CONFIRMATION="awaitingTransactionConfirmation",t.START_PRE_APPROVED_TRANSACTION="startPreApprovedTransaction"}(J||(J={})),function(t){t.COLLECTING="COLLECTING",t.PROCESSING="PROCESSING",t.IN_REVIEW="IN_REVIEW",t.COMPLETED="COMPLETED",t.FAILED="FAILED",t.NOT_FOUND="NOT_FOUND"}(z||(z={})),function(t){t.RESPONSE_PUBLIC_KEY="RESPONSE_PUBLIC_KEY",t.RESPONSE_DID="RESPONSE_DID",t.RESPONSE_SIGNED_PROOF="RESPONSE_SIGNED_PROOF",t.RESPONSE_SIGNED_MESSAGE="RESPONSE_SIGNED_MESSAGE",t.RESPONSE_ERROR="RESPONSE_ERROR"}(B||(B={})),function(t){t.REQUEST_PUBLIC_KEY="REQUEST_PUBLIC_KEY",t.REQUEST_DID="REQUEST_DID",t.REQUEST_SIGNED_PROOF="REQUEST_SIGNED_PROOF",t.REQUEST_SIGNED_MESSAGE="REQUEST_SIGNED_MESSAGE"}(Z||(Z={}));var et,nt=function(){function t(t,e,n,r){void 0===r&&(r=y("ListenerManager")),this.messageEventInterface=t,this.chainImplementation=e,this.instanceId=n,this.log=r,this.messageListeners={}}return t.prototype.registerCivicPassListener=function(t){var e=this,n=function(n){var r,a;n.data?(null===(r=n.data)||void 0===r?void 0:r.instanceId)===e.instanceId?Object.values(J).includes(n.data.action)&&(e.log.debug("received CivicPassListener postMessage",n.data),t(n.data)):(null===(a=n.data)||void 0===a?void 0:a.instanceId)&&"@devtools-page"!==n.data.source&&e.log.debug("instanceId for different instance",{event:n.data,instanceId:e.instanceId}):e.log.error("No data in response")};this.log.debug("Adding event listener for civic-pass events"),this.messageEventInterface.addMessageEventListener(n),this.messageListeners.civicPass=n},t.prototype.registerCivicSignListener=function(t){var e=this,n=function(n){var r,a;n.data?(null===(r=n.data)||void 0===r?void 0:r.instanceId)===e.instanceId?Object.values(Z).includes(n.data.request)&&(e.log.debug("received CivicSignListener postMessage",n.data),t(n.data)):(null===(a=n.data)||void 0===a?void 0:a.instanceId)&&"@devtools-page"!==n.data.source&&e.log.debug("instanceId for different instance",{event:n.data,instanceId:e.instanceId}):e.log.error("No data in response")};this.log.debug("Adding event listener for civic-sign events"),this.messageEventInterface.addMessageEventListener(n),this.messageListeners.civicSign=n},t.prototype.registerOnChainListeners=function(t){this.chainImplementation.on("TOKEN_CREATED",t),this.chainImplementation.on("TOKEN_CHANGED",t)},t.prototype.unregisterAllListeners=function(){var t=this;Object.entries(this.messageListeners).forEach((function(e){var n=e[0],r=e[1];t.log.debug("Removing message event listener",n),t.messageEventInterface.removeMessageEventListener(r),delete t.messageListeners[n]}))},t}();!function(t){t.IN_PROGRESS="IN_PROGRESS",t.COMPLETE="COMPLETE",t.ERROR="ERROR",t.RECEIVED="RECEIVED",t.RESPONDED="RESPONDED"}(et||(et={}));var rt,at=function(t){var e=t.gatekeeperSendsTransaction,n=t.payer,r=t.wallet;if(!e)return n||(null==r?void 0:r.address)},ot=y("remoteSign").debug,it=y("remoteSign").error,st=function(){function t(t,e){this.instanceId=e,this.postMessageTarget=t}return t.prototype.sendPublicKey=function(t,e){this.emit({event:B.RESPONSE_PUBLIC_KEY,data:e,requestId:t})},t.prototype.sendDid=function(t,e){this.emit({event:B.RESPONSE_DID,data:e,requestId:t})},t.prototype.sendSignedProof=function(t,e,n){this.emit({event:B.RESPONSE_SIGNED_PROOF,data:{proof:e,signatureMethod:n},requestId:t})},t.prototype.sendSignedMessage=function(t,e){this.emit({event:B.RESPONSE_SIGNED_MESSAGE,data:e,requestId:t})},t.prototype.sendError=function(t,e,n){this.emit({event:B.RESPONSE_ERROR,requestId:t,data:{request:e,error:{message:n.message,code:null==n?void 0:n.errorCode}}})},t.prototype.emit=function(t){this.postMessageTarget.postMessage(n(n({},t),{instanceId:this.instanceId}),"*")},t}(),ut=function(){function t(t,e,n){this.gatewayCoreStore=t,this.gatekeeperClient=e,this.abortController=n,this.log=y("OrchestratorFlow")}return t.prototype.setGatekeeperClientFlowId=function(){var t,e,n,r,a=this.gatewayCoreStore.getState();if(!(null===(e=null===(t=a.output)||void 0===t?void 0:t.flowParameters)||void 0===e?void 0:e.flowId))throw this.log.error("Missing flowId",a),new Error("Missing flowId");this.gatekeeperClient.setFlowId(null===(r=null===(n=a.output)||void 0===n?void 0:n.flowParameters)||void 0===r?void 0:r.flowId)},t}(),Et=function(t){var e=t.gatewayToken,n=t.tokenExpirationMarginSeconds,r=t.forceRequireRefresh,a=e||{},o=a.expiryTime,i=a.state===exports.State.ACTIVE;return!(!o||!i)&&(!!r||function(t){return!!t&&Math.floor(Date.now()/1e3)>=t}(o)||function(t,e){return t-Math.floor(Date.now()/1e3)<=e}(o,n))},dt=2147483647,ct=function(t,e){var n=t-Math.floor(Date.now()/1e3)-e,r=n>0?1e3*n:0;return r>=dt?2147483646:r},lt=function(t){function n(e,n,r,a,o){void 0===o&&(o=120);var i=t.call(this,e,r,a)||this;return i.gatewayCoreStore=e,i.chainImplementation=n,i.gatekeeperClient=r,i.abortController=a,i.expectTokenTimeoutSeconds=o,i.timers={},i.log=y("Issuance instance with expectTokenTimeoutSeconds ".concat(o)),i}return e(n,t),n.prototype.sendTransaction=function(){return r(this,void 0,void 0,(function(){var t,e,n,r,o,i,s,u=this;return a(this,(function(a){if(t=this.gatewayCoreStore.getState(),!(null===(r=t.inputs.gatekeeperRecord.received)||void 0===r?void 0:r.transaction))throw this.log.error("Missing gatekeeperRecord payload"),new Error("Missing gatekeeperRecord payload");if(this.gatewayCoreStore.setState((function(t){t.internal.chainTransaction||(t.internal.chainTransaction={attempts:0}),void 0!==t.internal.chainTransaction.attempts&&(t.internal.chainTransaction.attempts+=1),t.internal.chainTransaction.sentTxId=void 0,t.internal.errors.expectedOnChainToken=null,t.inputs.gatewayToken.status=et.COMPLETE,t.internal.chainTransaction.error=void 0,t.inputs.civicPass.received=null})),this.abortExpectedTokenTimer(),!this.chainImplementation.handleTransaction)throw this.log.error("No handleTransaction defined on chainImplementation."),new Error("No handleTransaction defined on chainImplementation");return e=null===(o=t.internal.chainDetails)||void 0===o?void 0:o.chainType,n=e?null===(s=null===(i=t.inputs.gatekeeperNetworkData.received)||void 0===i?void 0:i.chains[e])||void 0===s?void 0:s.frontendPollingTimeoutSeconds:void 0,this.chainImplementation.handleTransaction(t.inputs.gatekeeperRecord.received.transaction,n).then((function(t){u.abortController.signal.aborted||u.gatewayCoreStore.setState((function(e){e.internal.chainTransaction||(e.internal.chainTransaction={}),u.gatekeeperClient.updateTransactionStatus(t),e.internal.chainTransaction.sentTxId=t}))})).catch((function(t){u.gatewayCoreStore.setState((function(e){e.internal.chainTransaction||(e.internal.chainTransaction={}),e.internal.chainTransaction.error=t}))})),[2]}))}))},n.prototype.gatekeeperRequest=function(t,e){return r(this,void 0,void 0,(function(){var n,r,o;return a(this,(function(a){if(!(null===(n=e.inputs.civicPass.received)||void 0===n?void 0:n.payload))throw this.log.error("Missing civicPass payload",e),new Error("Missing civicPass payload");return this.currentPayload=null===(r=e.inputs.civicPass.received)||void 0===r?void 0:r.payload,[2,this.gatekeeperClient.requestGatewayTokenFromGatekeeper({payload:null===(o=e.inputs.civicPass.received)||void 0===o?void 0:o.payload,payer:t})]}))}))},n.prototype.freshTransactionGatekeeperRequest=function(t){return r(this,void 0,void 0,(function(){return a(this,(function(e){return[2,this.gatekeeperClient.fetchFreshTransaction({payer:t})]}))}))},n.prototype.clearStateBeforeGatekeeperRequest=function(t){void 0===t&&(t=!1),this.gatewayCoreStore.setState((function(e){e.internal.errors.expectedOnChainToken=null,e.inputs.gatewayToken.status=et.COMPLETE,e.inputs.gatekeeperRecord.received=null,e.inputs.gatekeeperRecord.status=et.IN_PROGRESS,t&&(e.internal.chainTransaction=void 0)}))},n.prototype.makeGatekeeperRequest=function(t){return r(this,arguments,void 0,(function(t){var e,n=this,r=t.payer,o=t.isFreshTransactionRequest;return a(this,(function(t){return e=this.gatewayCoreStore.getState(),this.setGatekeeperClientFlowId(),this.log.debug("makeGatekeeperRequest",e),this.abortExpectedTokenTimer(),this.clearStateBeforeGatekeeperRequest(o),(o?this.freshTransactionGatekeeperRequest(r):this.gatekeeperRequest(r,e)).then((function(t){n.abortController.signal.aborted||n.gatewayCoreStore.setState((function(e){e.inputs.gatekeeperRecord.status=et.COMPLETE,e.inputs.gatekeeperRecord.received=t}))})).catch((function(t){n.gatewayCoreStore.setState((function(e){e.inputs.gatekeeperRecord.status=et.ERROR,e.inputs.gatekeeperRecord.error=t}))})),[2]}))}))},n.prototype.retrieveFreshTransaction=function(t){return r(this,void 0,void 0,(function(){var e,n,r=this;return a(this,(function(a){if(e=this.gatewayCoreStore.getState(),!(null===(n=e.inputs.civicPass.received)||void 0===n?void 0:n.payload))throw this.log.error("Missing civicPass payload",e),new Error("Missing civicPass payload");return this.setGatekeeperClientFlowId(),this.log.debug("retrieveFreshTransaction",e),this.abortExpectedTokenTimer(),this.clearStateBeforeGatekeeperRequest(),this.gatekeeperRequest(t,e).then((function(t){r.abortController.signal.aborted||r.gatewayCoreStore.setState((function(e){e.inputs.gatekeeperRecord.status=et.COMPLETE,e.inputs.gatekeeperRecord.received=t}))})).catch((function(t){r.gatewayCoreStore.setState((function(e){e.inputs.gatekeeperRecord.status=et.ERROR,e.inputs.gatekeeperRecord.error=t}))})),[2]}))}))},n.prototype.statusHasValidToken=function(){return!!this.gatewayCoreStore.getState().inputs.gatewayToken.received},n.prototype.expectOnChainToken=function(){var t=this;this.gatewayCoreStore.getState().inputs.gatewayToken.received||this.timers.expectOnChainToken||(this.timers.expectOnChainToken=setTimeout((function(){t.gatewayCoreStore.setState((function(e){t.statusHasValidToken()||(e.internal.errors.expectedOnChainToken=new H("No on-chain token found within interval"))}))}),1e3*this.expectTokenTimeoutSeconds),this.log.debug("Started expected token timer",this.timers.expectOnChainToken))},n.prototype.abort=function(){this.abortExpectedTokenTimer(),this.abortRefreshCountdownTimer()},n.prototype.abortExpectedTokenTimer=function(){this.timers.expectOnChainToken&&(this.log.debug("Aborting expected token timer",this.timers.expectOnChainToken),clearTimeout(this.timers.expectOnChainToken))},n.prototype.onActiveTokenFound=function(){this.abortExpectedTokenTimer(),this.gatewayCoreStore.setState((function(t){var e;void 0!==(null===(e=t.inputs.dynamicParameters)||void 0===e?void 0:e.forceRequireRefresh)&&(t.inputs.gatekeeperRecord.received=null,t.internal.chainTransaction=void 0,t.inputs.dynamicParameters.forceRequireRefresh=!1)})),this.startRefreshCountdownTimer()},n.prototype.startRefreshCountdownTimer=function(){var t=this,e=this.gatewayCoreStore.getState().inputs.gatewayToken.received;if(null==e?void 0:e.expiryTime){this.abortRefreshCountdownTimer();var n=ct(e.expiryTime,0);this.timers.refreshCountdownTimer=setTimeout((function(){t.abortRefreshCountdownTimer()}),n),this.log.debug("Started refresh countdown timer",{gatewayToken:e,refreshCountdownTimer:this.timers.refreshCountdownTimer})}},n.prototype.abortRefreshCountdownTimer=function(){this.log.debug("abortRefreshCountdownTimer",{refreshCountdownTimer:this.timers.refreshCountdownTimer}),this.timers.refreshCountdownTimer&&(clearTimeout(this.timers.refreshCountdownTimer),this.timers.refreshCountdownTimer=void 0)},n.prototype.restartDataCollection=function(){this.gatewayCoreStore.setState((function(t){t.inputs.civicPass.received=null}))},n}(ut),St=function(t){function n(e,n,r,a,o){void 0===o&&(o=120);var i=t.call(this,e,n,r,a,o)||this;return i.gatewayCoreStore=e,i.chainImplementation=n,i.gatekeeperClient=r,i.abortController=a,i.expectTokenTimeoutSeconds=o,i}return e(n,t),n.prototype.clearStateBeforeGatekeeperRequest=function(){this.gatewayCoreStore.setState((function(t){t.inputs.gatekeeperRecord.received=null,t.internal.chainTransaction=void 0,t.inputs.gatekeeperRecord.status=et.IN_PROGRESS}))},n.prototype.gatekeeperRequest=function(t,e){return r(this,void 0,void 0,(function(){var n,r,o;return a(this,(function(a){if(!(null===(n=e.inputs.civicPass.received)||void 0===n?void 0:n.payload))throw this.log.error("Missing civicPass payload",e),new Error("Missing civicPass payload");return this.currentPayload=null===(r=e.inputs.civicPass.received)||void 0===r?void 0:r.payload,[2,this.gatekeeperClient.refreshToken({payload:null===(o=e.inputs.civicPass.received)||void 0===o?void 0:o.payload,payer:t})]}))}))},n.prototype.statusHasValidToken=function(){var t=this.gatewayCoreStore.getState().inputs.gatewayToken.received;return!!(null==t?void 0:t.expiryTime)&&!(!t||Et({gatewayToken:t,tokenExpirationMarginSeconds:0}))},n}(lt);!function(t){t.STARTED="started",t.FINISHED="finished"}(rt||(rt={}));var pt,_t=function(t){function n(e,n,r,a){void 0===a&&(a=2);var o=t.call(this,e,n,r)||this;return o.gatewayCoreStore=e,o.gatekeeperClient=n,o.abortController=r,o.pollingIntervalSeconds=a,o.timers={},o.log=y("PartnerReview instance"),o}return e(n,t),n.prototype.pollForReviewFinished=function(){return r(this,void 0,void 0,(function(){var t,e=this;return a(this,(function(n){return this.setGatekeeperClientFlowId(),t=function(){return r(e,void 0,void 0,(function(){var t,e=this;return a(this,(function(n){return(null===(t=this.abortController)||void 0===t?void 0:t.signal.aborted)?(clearInterval(this.timers.pollForReviewFinishedTimer),[2]):(this.gatekeeperClient.getGatekeeperRecordWithPayload().then((function(t){if(!t||void 0===(null==t?void 0:t.state)||(null==t?void 0:t.state)===l.SERVER_FAILURE)throw e.log.error("Error polling gatekeeper, no state returned",t),clearInterval(e.timers.pollForReviewFinishedTimer),new Error("Error polling gatekeeper, no state returned");e.log.debug("pollUntilNotRequested record.state",t.state),t.state!==l.REQUESTED&&(e.gatewayCoreStore.setState((function(e){e.inputs.gatekeeperRecord.status=et.COMPLETE,e.inputs.gatekeeperRecord.received=t})),clearInterval(e.timers.pollForReviewFinishedTimer))})),[2])}))}))},t(),this.timers.pollForReviewFinishedTimer=setInterval(t,1e3*this.pollingIntervalSeconds),[2]}))}))},n.prototype.abort=function(){clearInterval(this.timers.pollForReviewFinishedTimer)},n}(ut),Rt=y("common").error,Tt=((pt={})[z.COLLECTING]=exports.GatewayStatus.COLLECTING_USER_INFORMATION,pt[z.PROCESSING]=exports.GatewayStatus.VALIDATING_USER_INFORMATION,pt[z.IN_REVIEW]=exports.GatewayStatus.VALIDATING_USER_INFORMATION,pt[z.FAILED]=exports.GatewayStatus.USER_INFORMATION_REJECTED,pt[z.COMPLETED]=exports.GatewayStatus.USER_INFORMATION_VALIDATED,pt),Nt=function(t){var e,n,r;return!((null===(e=t.inputs.parameters)||void 0===e?void 0:e.payer)!==(null===(r=null===(n=t.inputs.parameters)||void 0===n?void 0:n.wallet)||void 0===r?void 0:r.address))},It=function(t){var e,n,r;return!(!(null===(e=t.inputs.gatewayToken)||void 0===e?void 0:e.received)||(null===(r=null===(n=t.inputs.gatekeeperRecord)||void 0===n?void 0:n.received)||void 0===r?void 0:r.state)!==l.NOT_REQUESTED)},vt=function(t){var e,n,r=null===(e=t.inputs.gatewayToken)||void 0===e?void 0:e.received;if(It(t))return exports.GatewayStatus.ERROR;if(r){var a=Et({gatewayToken:r,tokenExpirationMarginSeconds:0,forceRequireRefresh:null===(n=t.inputs.dynamicParameters)||void 0===n?void 0:n.forceRequireRefresh});switch(r.state){case"ACTIVE":return a?exports.GatewayStatus.REFRESH_TOKEN_REQUIRED:exports.GatewayStatus.ACTIVE;case"FROZEN":return exports.GatewayStatus.FROZEN;case"REVOKED":return exports.GatewayStatus.REVOKED;default:return Rt("Unexpected token state: ".concat(r.state)),exports.GatewayStatus.ERROR}}},At=function(t){var e=vt(t);return e||(Rt("The gateway status indicated an existing token but no status could be derived"),exports.GatewayStatus.ERROR)},ft=function(t){var e,n=t.inputs.gatekeeperRecord,r=t.inputs.gatewayToken;switch(null===(e=null==n?void 0:n.received)||void 0===e?void 0:e.state){case l.ISSUED_EXPIRED:return(null==r?void 0:r.received)?void 0:exports.GatewayStatus.ERROR;case l.REJECTED:return exports.GatewayStatus.REJECTED;case l.ISSUED_LOCATION_NOT_SUPPORTED:case l.LOCATION_NOT_SUPPORTED:return exports.GatewayStatus.LOCATION_NOT_SUPPORTED;case l.ISSUED_VPN_NOT_SUPPORTED:case l.VPN_NOT_SUPPORTED:return exports.GatewayStatus.VPN_NOT_SUPPORTED;case l.REQUESTED_RETRIES_EXHAUSTED:return exports.GatewayStatus.ERROR;default:return}},yt=function(){function t(t,e,r,a,o,i,s){var u,E,d,c,l,S,p,_;if(this.gatewayCoreStore=t,this.messageEventInterface=e,this.instanceId=r,this.inputs=a,this.postMessageTargetCallback=i,this.chainImplementation=s,this.abortController=new AbortController,!this.chainImplementation||!(null===(u=a.wallet)||void 0===u?void 0:u.address)||!a.stage)throw new Error("chainImplementation wallet and stage are required");this.wallet=a.wallet,this.payer=at(a),this.log=y("Orchestrator[".concat(this.instanceId,"]")),this.listenerManager=new nt(this.messageEventInterface,this.chainImplementation,this.instanceId);var R=null===(d=null===(E=this.chainImplementation)||void 0===E?void 0:E.chainDetails)||void 0===d?void 0:d.chainNetwork;this.gatekeeperClient=new b({abortController:this.abortController,baseUrl:null===(c=a.gatekeeperConfig)||void 0===c?void 0:c.baseUrl,queryParams:a.gatekeeperNetwork?{network:R,gatekeeperNetworkAddress:a.gatekeeperNetwork}:void 0,headers:n(n({},(null===(l=a.gatekeeperConfig)||void 0===l?void 0:l.headers)||{}),a.xCivicClientHeader?{"x-civic-client":a.xCivicClientHeader}:{}),stage:a.stage,fetchImplementation:o.fetchImplementation,numRetries:o.numRetries,walletAddress:null===(S=a.wallet)||void 0===S?void 0:S.address,chainType:null===(_=null===(p=this.chainImplementation)||void 0===p?void 0:p.chainDetails)||void 0===_?void 0:_.chainType}),this.log.debug("Orchestrator created")}return Object.defineProperty(t.prototype,"issuance",{get:function(){return this._issuance||(this._issuance=new lt(this.gatewayCoreStore,this.chainImplementation,this.gatekeeperClient,this.abortController,this.inputs.expectTokenTimeoutSeconds)),this._issuance},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"refresh",{get:function(){return this._refresh||(this._refresh=new St(this.gatewayCoreStore,this.chainImplementation,this.gatekeeperClient,this.abortController,this.inputs.expectTokenTimeoutSeconds)),this._refresh},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"partnerReview",{get:function(){return this._partnerReview||(this._partnerReview=new _t(this.gatewayCoreStore,this.gatekeeperClient,this.abortController,this.inputs.gatekeeperPollingIntervalSeconds)),this._partnerReview},enumerable:!1,configurable:!0}),t.prototype.getRemoteSignInstance=function(){var t;return this.remoteSignInstance||(this.remoteSignInstance=new st((t=this.postMessageTargetCallback(this.instanceId),{postMessage:function(e,n){t.postMessage(e,n)}}),this.instanceId)),this.remoteSignInstance},t.prototype.getOwnerDids=function(){return r(this,void 0,void 0,(function(){var t;return a(this,(function(e){switch(e.label){case 0:return[4,this.chainImplementation.ownerDids()];case 1:return t=e.sent(),this.gatewayCoreStore.setState((function(e){e.internal.ownerDids=t})),[2]}}))}))},t.prototype.fetchGatekeeperNetworkData=function(){return r(this,void 0,void 0,(function(){var t=this;return a(this,(function(e){return this.gatewayCoreStore.setState((function(t){t.inputs.gatekeeperNetworkData.status=et.IN_PROGRESS})),[2,K(this.inputs.stage||"prod",this.inputs.gatekeeperNetwork||"").then((function(e){t.log.debug("getGatekeeperNetworkData",e),t.abortController.signal.aborted||t.gatewayCoreStore.setState((function(t){t.inputs.gatekeeperNetworkData.status=et.COMPLETE,t.inputs.gatekeeperNetworkData.received=e}))})).catch((function(e){t.log.error("Error retrieving gatekeeper network data",e),t.abortController.signal.aborted||t.gatewayCoreStore.setState((function(t){t.inputs.gatekeeperNetworkData.status=et.ERROR,t.inputs.gatekeeperNetworkData.error=e}))}))]}))}))},t.prototype.lookupTokenState=function(){return r(this,void 0,void 0,(function(){var t,e,n,o=this;return a(this,(function(i){switch(i.label){case 0:return t=function(){return r(o,void 0,void 0,(function(){var t=this;return a(this,(function(e){return this.gatewayCoreStore.setState((function(t){t.inputs.gatekeeperRecord.status=et.IN_PROGRESS})),[2,this.gatekeeperClient.getGatekeeperRecordWithPayload().then((function(e){t.log.debug("getGatekeeperRecordWithPayload record",e),t.abortController.signal.aborted||t.gatewayCoreStore.setState((function(t){t.inputs.gatekeeperRecord.status=et.COMPLETE,t.inputs.gatekeeperRecord.received=e}))})).catch((function(e){t.log.error("Error retrieving gatekeeper record",e),t.abortController.signal.aborted||t.gatewayCoreStore.setState((function(t){t.inputs.gatekeeperRecord.status=et.ERROR,t.inputs.gatekeeperRecord.error=e}))}))]}))}))},e=function(){return r(o,void 0,void 0,(function(){var t=this;return a(this,(function(e){return this.gatewayCoreStore.setState((function(t){t.inputs.gatewayToken.status=et.IN_PROGRESS})),[2,this.chainImplementation.findGatewayToken().then((function(e){t.abortController.signal.aborted||t.gatewayCoreStore.setState((function(t){t.inputs.gatewayToken.status=et.COMPLETE,e&&(t.inputs.gatewayToken.received=e)}))})).catch((function(e){t.abortController.signal.aborted||(t.log.error("Error retrieving gateway token",e),t.gatewayCoreStore.setState((function(t){t.inputs.gatewayToken.status=et.ERROR,t.inputs.gatewayToken.error=e})))}))]}))}))},n=[e()],this.inputs.disableInitialGatekeeperLookup||n.push(t()),[4,Promise.allSettled(n)];case 1:return i.sent(),[2]}}))}))},t.prototype.initialise=function(){return r(this,void 0,void 0,(function(){return a(this,(function(t){switch(t.label){case 0:return this.log.debug("Initialising orchestrator"),this.abortController=new AbortController,this.remoteSignInstance=void 0,this.gatewayCoreStore.getState().functions.reset(),[4,Promise.allSettled([this.getOwnerDids(),this.lookupTokenState(),this.fetchGatekeeperNetworkData()])];case 1:return t.sent(),[2]}}))}))},t.prototype.reset=function(){this.log.debug("resetting orchestrator"),this.initialise()},t.prototype.onInternalStatusChange=function(t,e){var n,r;if(t!==exports.GatewayStatus.ERROR){if(t!==exports.GatewayStatus.ACTIVE)return t===exports.ExtendedGatewayStatus.ISSUANCE_RESTART_DATA_COLLECTION?this.issuance.restartDataCollection():t===exports.GatewayStatus.USER_INFORMATION_VALIDATED?this.issuance.makeGatekeeperRequest({payer:this.payer}):[exports.ExtendedGatewayStatus.ISSUANCE_CLIENT_SENDS_REQUEST_NEW_TX,exports.ExtendedGatewayStatus.ISSUANCE_CLIENT_THIRD_PARTY_SENDS_REQUEST_NEW_TX].includes(t)?this.issuance.makeGatekeeperRequest({payer:this.payer,isFreshTransactionRequest:!0}):[exports.ExtendedGatewayStatus.ISSUANCE_AWAITING_TRANSACTION_SEND,exports.ExtendedGatewayStatus.ISSUANCE_AWAITING_THIRD_PARTY_TRANSACTION_SEND].includes(t)?this.issuance.sendTransaction():t===exports.ExtendedGatewayStatus.ISSUANCE_AWAITING_ON_CHAIN_TOKEN?this.issuance.expectOnChainToken():t===exports.ExtendedGatewayStatus.REFRESH_USER_INFORMATION_VALIDATED?this.refresh.makeGatekeeperRequest({payer:this.payer}):[exports.ExtendedGatewayStatus.REFRESH_CLIENT_SENDS_REQUEST_NEW_TX,exports.ExtendedGatewayStatus.REFRESH_CLIENT_THIRD_PARTY_SENDS_REQUEST_NEW_TX].includes(t)?this.refresh.makeGatekeeperRequest({payer:this.payer,isFreshTransactionRequest:!0}):t===exports.ExtendedGatewayStatus.REFRESH_AWAITING_TRANSACTION_SEND?this.refresh.sendTransaction():t===exports.ExtendedGatewayStatus.REFRESH_AWAITING_ON_CHAIN_TOKEN?this.refresh.expectOnChainToken():t===exports.ExtendedGatewayStatus.TOKEN_IN_PARTNER_REVIEW?this.partnerReview.pollForReviewFinished():[exports.ExtendedGatewayStatus.RESTART,exports.ExtendedGatewayStatus.RESTART_REFRESH].includes(t)?this.reset():void 0;e!==exports.GatewayStatus.ACTIVE&&(null===(n=this._refresh)||void 0===n||n.onActiveTokenFound(),this._refresh||null===(r=this._issuance)||void 0===r||r.onActiveTokenFound())}else{var a=this.gatewayCoreStore.getState();It(a)&&this.gatewayCoreStore.setState((function(t){t.internal.errors||(t.internal.errors={}),t.internal.errors.expectedTokenGatekeeperRecord=new L("Token has no gatekeeper record",k.EXPECTED_GATEKEEPER_RECORD)}))}},t.prototype.orchestrate=function(){var t=this;this.log.debug("running orchestrate()"),this.gatewayCoreStore.subscribe((function(t){return t.internal.status}),(function(e,n){return t.onInternalStatusChange(e,n)})),this.gatewayCoreStore.subscribe((function(t){var e;return null===(e=t.inputs.gatewayToken.received)||void 0===e?void 0:e.expiryTime}),(function(e,n){e&&n&&e>n&&t.gatewayCoreStore.setState((function(t){var e;void 0!==(null===(e=t.inputs.dynamicParameters)||void 0===e?void 0:e.forceRequireRefresh)&&(t.inputs.dynamicParameters.forceRequireRefresh=!1)}))})),this.gatewayCoreStore.subscribe((function(t){return t.inputs.civicPass.received}),(function(e){return t.gatewayCoreStore.setState((function(t){var n=function(t,e){var n,r;return[J.TOKEN_ACTIVE,J.TOKEN_REVOKED,J.TOKEN_FROZEN,J.TOKEN_REJECTED,J.FAILED_IP_CHECK,J.FAILED_VPN_CHECK,J.ERROR].includes(e)?rt.FINISHED:null===(r=null===(n=t.internal)||void 0===n?void 0:n.userInteraction)||void 0===r?void 0:r.status}(t,null==e?void 0:e.action);t.internal.userInteraction.status=n}))})),this.listenerManager.registerCivicPassListener((function(e){t.gatewayCoreStore.setState((function(t){t.inputs.civicPass.status=et.COMPLETE,t.inputs.civicPass.received=e}))})),this.listenerManager.registerCivicSignListener((function(e){t.gatewayCoreStore.setState((function(t){t.inputs.civicSign.status=et.RECEIVED,t.inputs.civicSign.received=e}));var n,o,i,s=t.gatewayCoreStore.getState().internal.ownerDids;(n=e,o=t.getRemoteSignInstance(),i={chainImplementation:t.chainImplementation,wallet:t.wallet,ownerDids:s},r(void 0,void 0,void 0,(function(){var t,e,r,s,u,E,d,c,l,S;return a(this,(function(a){switch(a.label){case 0:t=i.wallet,e=i.chainImplementation,a.label=1;case 1:return a.trys.push([1,8,,9]),(s=i.ownerDids)?[3,3]:[4,e.ownerDids()];case 2:s=a.sent(),a.label=3;case 3:return r=s,ot("handleRemoteSignEvent ".concat(n.request),{remoteSignerInst:o,wallet:t,chainImplDids:r}),Object.values(Z).includes(n.request)?n.request===Z.REQUEST_PUBLIC_KEY?(null==o||o.sendPublicKey(n.requestId,t.address),[2,t.address]):n.request===Z.REQUEST_DID?(null==o||o.sendDid(n.requestId,null==r?void 0:r[0]),[2,null==r?void 0:r[0]]):n.request!==Z.REQUEST_SIGNED_PROOF?[3,5]:[4,e.proveWalletOwnership(n.payload)]:(it("No result from remote sign event"),[2]);case 4:return u=a.sent(),null==o||o.sendSignedProof(n.requestId,u.proof,u.signatureMethod),[2,{proof:u.proof,signatureMethod:u.signatureMethod}];case 5:if(n.request!==Z.REQUEST_SIGNED_MESSAGE)return[3,7];if(!n.payload)return[3,7];if(!e.signMessage)throw new Error("Chain implementation does not support signMessage");return[4,null===(S=e.signMessage)||void 0===S?void 0:S.call(e,Buffer.from(n.payload))];case 6:return E=a.sent(),null==o||o.sendSignedMessage(n.requestId,E),[2,E];case 7:return[3,9];case 8:return d=a.sent(),c=d.errorCode||d.code||k.POWO_ERROR,l=new L(d.message,"".concat(c)),it("Error handling remote sign event, sending back an error response with code ".concat(c),l),null==o||o.sendError(n.requestId,n.request,l),[2,{request:n.request,error:l}];case 9:return[2]}}))}))).then((function(e){e||t.log.warn("No result from remote sign event"),t.gatewayCoreStore.setState((function(t){t.inputs.civicSign.received=null,t.inputs.civicSign.sent=e,t.inputs.civicSign.error=null,t.inputs.civicSign.status=et.RESPONDED}))})).catch((function(e){t.gatewayCoreStore.setState((function(t){var n=e.errorCode?e:new L("handleRemoteSignEvent failed",k.POWO_ERROR);t.inputs.civicSign.error=n,t.inputs.civicSign.status=et.ERROR}))}))})),this.listenerManager.registerOnChainListeners((function(e){t.gatewayCoreStore.setState((function(t){t.inputs.gatewayToken.received=e}))}))},t.prototype.abort=function(){var t,e,n;this.log.info("Aborting orchestration"),this.chainImplementation.onDestroy(),null===(t=this._issuance)||void 0===t||t.abort(),null===(e=this._refresh)||void 0===e||e.abort(),null===(n=this._partnerReview)||void 0===n||n.abort(),this.abortController.abort(),this.gatekeeperClient.abort(),this.listenerManager.unregisterAllListeners()},t}();const ht=t=>{let e;const n=new Set,r=(t,r)=>{const a="function"==typeof t?t(e):t;if(!Object.is(a,e)){const t=e;e=(null!=r?r:"object"!=typeof a||null===a)?a:Object.assign({},e,a),n.forEach((n=>n(e,t)))}},a=()=>e,o={setState:r,getState:a,getInitialState:()=>i,subscribe:t=>(n.add(t),()=>n.delete(t)),destroy:()=>{console.warn("[DEPRECATED] The `destroy` method will be unsupported in a future version. Instead use unsubscribe function returned by subscribe. Everything will be garbage-collected if store is garbage-collected."),n.clear()}},i=e=t(r,a,o);return o};var Ot=Symbol.for("immer-nothing"),wt=Symbol.for("immer-draftable"),Ct=Symbol.for("immer-state"),gt="production"!==process.env.NODE_ENV?[function(t){return`The plugin for '${t}' has not been loaded into Immer. To enable the plugin, import and call \`enable${t}()\` when initializing your application.`},function(t){return`produce can only be called on things that are draftable: plain objects, arrays, Map, Set or classes that are marked with '[immerable]: true'. Got '${t}'`},"This object has been frozen and should not be mutated",function(t){return"Cannot use a proxy that has been revoked. Did you pass an object from inside an immer function to an async process? "+t},"An immer producer returned a new value *and* modified its draft. Either return a new value *or* modify the draft.","Immer forbids circular references","The first or second argument to `produce` must be a function","The third argument to `produce` must be a function or undefined","First argument to `createDraft` must be a plain object, an array, or an immerable object","First argument to `finishDraft` must be a draft returned by `createDraft`",function(t){return`'current' expects a draft, got: ${t}`},"Object.defineProperty() cannot be used on an Immer draft","Object.setPrototypeOf() cannot be used on an Immer draft","Immer only supports deleting array indices","Immer only supports setting array indices and the 'length' property",function(t){return`'original' expects a draft, got: ${t}`}]:[];function xt(t,...e){if("production"!==process.env.NODE_ENV){const n=gt[t],r="function"==typeof n?n.apply(null,e):n;throw new Error(`[Immer] ${r}`)}throw new Error(`[Immer] minified error nr: ${t}. Full error at: https://bit.ly/3cXEKWf`)}var Gt=Object.getPrototypeOf;function Dt(t){return!!t&&!!t[Ct]}function mt(t){return!!t&&(bt(t)||Array.isArray(t)||!!t[wt]||!!t.constructor?.[wt]||Ht(t)||Wt(t))}var Ut=Object.prototype.constructor.toString();function bt(t){if(!t||"object"!=typeof t)return!1;const e=Gt(t);if(null===e)return!0;const n=Object.hasOwnProperty.call(e,"constructor")&&e.constructor;return n===Object||"function"==typeof n&&Function.toString.call(n)===Ut}function Pt(t,e){0===Ft(t)?Reflect.ownKeys(t).forEach((n=>{e(n,t[n],t)})):t.forEach(((n,r)=>e(r,n,t)))}function Ft(t){const e=t[Ct];return e?e.type_:Array.isArray(t)?1:Ht(t)?2:Wt(t)?3:0}function kt(t,e){return 2===Ft(t)?t.has(e):Object.prototype.hasOwnProperty.call(t,e)}function Lt(t,e,n){const r=Ft(t);2===r?t.set(e,n):3===r?t.add(n):t[e]=n}function Ht(t){return t instanceof Map}function Wt(t){return t instanceof Set}function Mt(t){return t.copy_||t.base_}function Vt(t,e){if(Ht(t))return new Map(t);if(Wt(t))return new Set(t);if(Array.isArray(t))return Array.prototype.slice.call(t);if(!e&&bt(t)){if(!Gt(t)){const e=Object.create(null);return Object.assign(e,t)}return{...t}}const n=Object.getOwnPropertyDescriptors(t);delete n[Ct];let r=Reflect.ownKeys(n);for(let e=0;e<r.length;e++){const a=r[e],o=n[a];!1===o.writable&&(o.writable=!0,o.configurable=!0),(o.get||o.set)&&(n[a]={configurable:!0,writable:!0,enumerable:o.enumerable,value:t[a]})}return Object.create(Gt(t),n)}function Kt(t,e=!1){return jt(t)||Dt(t)||!mt(t)||(Ft(t)>1&&(t.set=t.add=t.clear=t.delete=Qt),Object.freeze(t),e&&Object.entries(t).forEach((([t,e])=>Kt(e,!0)))),t}function Qt(){xt(2)}function jt(t){return Object.isFrozen(t)}var qt,Xt={};function Yt(t){const e=Xt[t];return e||xt(0,t),e}function Jt(){return qt}function zt(t,e){e&&(Yt("Patches"),t.patches_=[],t.inversePatches_=[],t.patchListener_=e)}function Bt(t){Zt(t),t.drafts_.forEach(te),t.drafts_=null}function Zt(t){t===qt&&(qt=t.parent_)}function $t(t){return qt={drafts_:[],parent_:qt,immer_:t,canAutoFreeze_:!0,unfinalizedDrafts_:0}}function te(t){const e=t[Ct];0===e.type_||1===e.type_?e.revoke_():e.revoked_=!0}function ee(t,e){e.unfinalizedDrafts_=e.drafts_.length;const n=e.drafts_[0];return void 0!==t&&t!==n?(n[Ct].modified_&&(Bt(e),xt(4)),mt(t)&&(t=ne(e,t),e.parent_||ae(e,t)),e.patches_&&Yt("Patches").generateReplacementPatches_(n[Ct].base_,t,e.patches_,e.inversePatches_)):t=ne(e,n,[]),Bt(e),e.patches_&&e.patchListener_(e.patches_,e.inversePatches_),t!==Ot?t:void 0}function ne(t,e,n){if(jt(e))return e;const r=e[Ct];if(!r)return Pt(e,((a,o)=>re(t,r,e,a,o,n))),e;if(r.scope_!==t)return e;if(!r.modified_)return ae(t,r.base_,!0),r.base_;if(!r.finalized_){r.finalized_=!0,r.scope_.unfinalizedDrafts_--;const e=r.copy_;let a=e,o=!1;3===r.type_&&(a=new Set(e),e.clear(),o=!0),Pt(a,((a,i)=>re(t,r,e,a,i,n,o))),ae(t,e,!1),n&&t.patches_&&Yt("Patches").generatePatches_(r,n,t.patches_,t.inversePatches_)}return r.copy_}function re(t,e,n,r,a,o,i){if("production"!==process.env.NODE_ENV&&a===n&&xt(5),Dt(a)){const i=ne(t,a,o&&e&&3!==e.type_&&!kt(e.assigned_,r)?o.concat(r):void 0);if(Lt(n,r,i),!Dt(i))return;t.canAutoFreeze_=!1}else i&&n.add(a);if(mt(a)&&!jt(a)){if(!t.immer_.autoFreeze_&&t.unfinalizedDrafts_<1)return;ne(t,a),e&&e.scope_.parent_||"symbol"==typeof r||!Object.prototype.propertyIsEnumerable.call(n,r)||ae(t,a)}}function ae(t,e,n=!1){!t.parent_&&t.immer_.autoFreeze_&&t.canAutoFreeze_&&Kt(e,n)}var oe={get(t,e){if(e===Ct)return t;const n=Mt(t);if(!kt(n,e))return function(t,e,n){const r=ue(e,n);return r?"value"in r?r.value:r.get?.call(t.draft_):void 0}(t,n,e);const r=n[e];return t.finalized_||!mt(r)?r:r===se(t.base_,e)?(de(t),t.copy_[e]=ce(r,t)):r},has:(t,e)=>e in Mt(t),ownKeys:t=>Reflect.ownKeys(Mt(t)),set(t,e,n){const r=ue(Mt(t),e);if(r?.set)return r.set.call(t.draft_,n),!0;if(!t.modified_){const r=se(Mt(t),e),i=r?.[Ct];if(i&&i.base_===n)return t.copy_[e]=n,t.assigned_[e]=!1,!0;if(((a=n)===(o=r)?0!==a||1/a==1/o:a!=a&&o!=o)&&(void 0!==n||kt(t.base_,e)))return!0;de(t),Ee(t)}var a,o;return t.copy_[e]===n&&(void 0!==n||e in t.copy_)||Number.isNaN(n)&&Number.isNaN(t.copy_[e])||(t.copy_[e]=n,t.assigned_[e]=!0),!0},deleteProperty:(t,e)=>(void 0!==se(t.base_,e)||e in t.base_?(t.assigned_[e]=!1,de(t),Ee(t)):delete t.assigned_[e],t.copy_&&delete t.copy_[e],!0),getOwnPropertyDescriptor(t,e){const n=Mt(t),r=Reflect.getOwnPropertyDescriptor(n,e);return r?{writable:!0,configurable:1!==t.type_||"length"!==e,enumerable:r.enumerable,value:n[e]}:r},defineProperty(){xt(11)},getPrototypeOf:t=>Gt(t.base_),setPrototypeOf(){xt(12)}},ie={};function se(t,e){const n=t[Ct];return(n?Mt(n):t)[e]}function ue(t,e){if(!(e in t))return;let n=Gt(t);for(;n;){const t=Object.getOwnPropertyDescriptor(n,e);if(t)return t;n=Gt(n)}}function Ee(t){t.modified_||(t.modified_=!0,t.parent_&&Ee(t.parent_))}function de(t){t.copy_||(t.copy_=Vt(t.base_,t.scope_.immer_.useStrictShallowCopy_))}Pt(oe,((t,e)=>{ie[t]=function(){return arguments[0]=arguments[0][0],e.apply(this,arguments)}})),ie.deleteProperty=function(t,e){return"production"!==process.env.NODE_ENV&&isNaN(parseInt(e))&&xt(13),ie.set.call(this,t,e,void 0)},ie.set=function(t,e,n){return"production"!==process.env.NODE_ENV&&"length"!==e&&isNaN(parseInt(e))&&xt(14),oe.set.call(this,t[0],e,n,t[0])};function ce(t,e){const n=Ht(t)?Yt("MapSet").proxyMap_(t,e):Wt(t)?Yt("MapSet").proxySet_(t,e):function(t,e){const n=Array.isArray(t),r={type_:n?1:0,scope_:e?e.scope_:Jt(),modified_:!1,finalized_:!1,assigned_:{},parent_:e,base_:t,draft_:null,copy_:null,revoke_:null,isManual_:!1};let a=r,o=oe;n&&(a=[r],o=ie);const{revoke:i,proxy:s}=Proxy.revocable(a,o);return r.draft_=s,r.revoke_=i,s}(t,e);return(e?e.scope_:Jt()).drafts_.push(n),n}function le(t){if(!mt(t)||jt(t))return t;const e=t[Ct];let n;if(e){if(!e.modified_)return e.base_;e.finalized_=!0,n=Vt(t,e.scope_.immer_.useStrictShallowCopy_)}else n=Vt(t,!0);return Pt(n,((t,e)=>{Lt(n,t,le(e))})),e&&(e.finalized_=!1),n}var Se=new class{constructor(t){this.autoFreeze_=!0,this.useStrictShallowCopy_=!1,this.produce=(t,e,n)=>{if("function"==typeof t&&"function"!=typeof e){const n=e;e=t;const r=this;return function(t=n,...a){return r.produce(t,(t=>e.call(this,t,...a)))}}let r;if("function"!=typeof e&&xt(6),void 0!==n&&"function"!=typeof n&&xt(7),mt(t)){const a=$t(this),o=ce(t,void 0);let i=!0;try{r=e(o),i=!1}finally{i?Bt(a):Zt(a)}return zt(a,n),ee(r,a)}if(!t||"object"!=typeof t){if(r=e(t),void 0===r&&(r=t),r===Ot&&(r=void 0),this.autoFreeze_&&Kt(r,!0),n){const e=[],a=[];Yt("Patches").generateReplacementPatches_(t,r,e,a),n(e,a)}return r}xt(1,t)},this.produceWithPatches=(t,e)=>{if("function"==typeof t)return(e,...n)=>this.produceWithPatches(e,(e=>t(e,...n)));let n,r;return[this.produce(t,e,((t,e)=>{n=t,r=e})),n,r]},"boolean"==typeof t?.autoFreeze&&this.setAutoFreeze(t.autoFreeze),"boolean"==typeof t?.useStrictShallowCopy&&this.setUseStrictShallowCopy(t.useStrictShallowCopy)}createDraft(t){mt(t)||xt(8),Dt(t)&&(t=function(t){Dt(t)||xt(10,t);return le(t)}(t));const e=$t(this),n=ce(t,void 0);return n[Ct].isManual_=!0,Zt(e),n}finishDraft(t,e){const n=t&&t[Ct];n&&n.isManual_||xt(9);const{scope_:r}=n;return zt(r,e),ee(void 0,r)}setAutoFreeze(t){this.autoFreeze_=t}setUseStrictShallowCopy(t){this.useStrictShallowCopy_=t}applyPatches(t,e){let n;for(n=e.length-1;n>=0;n--){const r=e[n];if(0===r.path.length&&"replace"===r.op){t=r.value;break}}n>-1&&(e=e.slice(n+1));const r=Yt("Patches").applyPatches_;return Dt(t)?r(t,e):this.produce(t,(t=>r(t,e)))}},pe=Se.produce;Se.produceWithPatches.bind(Se),Se.setAutoFreeze.bind(Se),Se.setUseStrictShallowCopy.bind(Se),Se.applyPatches.bind(Se),Se.createDraft.bind(Se),Se.finishDraft.bind(Se);const _e=t=>(e,n,r)=>(r.setState=(t,n,...r)=>{const a="function"==typeof t?pe(t):t;return e(a,n,...r)},t(r.setState,n,r)),Re=new Map,Te=t=>{const e=Re.get(t);return e?Object.fromEntries(Object.entries(e.stores).map((([t,e])=>[t,e.getState()]))):{}},Ne=(t,e={})=>(n,r,a)=>{const{enabled:o,anonymousActionType:i,store:s,...u}=e;let E;try{E=(null==o||o)&&window.__REDUX_DEVTOOLS_EXTENSION__}catch(t){}if(!E)return o&&console.warn("[zustand devtools middleware] Please install/enable Redux devtools extension"),t(n,r,a);const{connection:d,...c}=((t,e,n)=>{if(void 0===t)return{type:"untracked",connection:e.connect(n)};const r=Re.get(n.name);if(r)return{type:"tracked",store:t,...r};const a={connection:e.connect(n),stores:{}};return Re.set(n.name,a),{type:"tracked",store:t,...a}})(s,E,u);let l=!0;a.setState=(t,e,o)=>{const E=n(t,e);if(!l)return E;const c=void 0===o?{type:i||"anonymous"}:"string"==typeof o?{type:o}:o;return void 0===s?(null==d||d.send(c,r()),E):(null==d||d.send({...c,type:`${s}/${c.type}`},{...Te(u.name),[s]:a.getState()}),E)};const S=(...t)=>{const e=l;l=!1,n(...t),l=e},p=t(a.setState,r,a);if("untracked"===c.type?null==d||d.init(p):(c.stores[c.store]=a,null==d||d.init(Object.fromEntries(Object.entries(c.stores).map((([t,e])=>[t,t===c.store?p:e.getState()]))))),a.dispatchFromDevtools&&"function"==typeof a.dispatch){let t=!1;const e=a.dispatch;a.dispatch=(...n)=>{"__setState"!==n[0].type||t||(console.warn('[zustand devtools middleware] "__setState" action type is reserved to set state from the devtools. Avoid using it.'),t=!0),e(...n)}}return d.subscribe((t=>{var e;switch(t.type){case"ACTION":return"string"!=typeof t.payload?void console.error("[zustand devtools middleware] Unsupported action format"):Ie(t.payload,(t=>{if("__setState"!==t.type)a.dispatchFromDevtools&&"function"==typeof a.dispatch&&a.dispatch(t);else{if(void 0===s)return void S(t.state);1!==Object.keys(t.state).length&&console.error('\n                    [zustand devtools middleware] Unsupported __setState action format. \n                    When using \'store\' option in devtools(), the \'state\' should have only one key, which is a value of \'store\' that was passed in devtools(),\n                    and value of this only key should be a state object. Example: { "type": "__setState", "state": { "abc123Store": { "foo": "bar" } } }\n                    ');const e=t.state[s];if(null==e)return;JSON.stringify(a.getState())!==JSON.stringify(e)&&S(e)}}));case"DISPATCH":switch(t.payload.type){case"RESET":return S(p),void 0===s?null==d?void 0:d.init(a.getState()):null==d?void 0:d.init(Te(u.name));case"COMMIT":return void 0===s?void(null==d||d.init(a.getState())):null==d?void 0:d.init(Te(u.name));case"ROLLBACK":return Ie(t.state,(t=>{if(void 0===s)return S(t),void(null==d||d.init(a.getState()));S(t[s]),null==d||d.init(Te(u.name))}));case"JUMP_TO_STATE":case"JUMP_TO_ACTION":return Ie(t.state,(t=>{void 0!==s?JSON.stringify(a.getState())!==JSON.stringify(t[s])&&S(t[s]):S(t)}));case"IMPORT_STATE":{const{nextLiftedState:n}=t.payload,r=null==(e=n.computedStates.slice(-1)[0])?void 0:e.state;if(!r)return;return S(void 0===s?r:r[s]),void(null==d||d.send(null,n))}case"PAUSE_RECORDING":return l=!l}return}})),p},Ie=(t,e)=>{let n;try{n=JSON.parse(t)}catch(t){console.error("[zustand devtools middleware] Could not parse the received json",t)}void 0!==n&&e(n)},ve=t=>(e,n,r)=>{const a=r.subscribe;r.subscribe=(t,e,n)=>{let o=t;if(e){const a=(null==n?void 0:n.equalityFn)||Object.is;let i=t(r.getState());o=n=>{const r=t(n);if(!a(i,r)){const t=i;e(i=r,t)}},(null==n?void 0:n.fireImmediately)&&e(i,i)}return a(o)};return t(e,n,r)};function Ae(){return Ae=Object.assign?Object.assign.bind():function(t){for(var e=1;e<arguments.length;e++){var n=arguments[e];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(t[r]=n[r])}return t},Ae.apply(this,arguments)}var fe="$$_computed_";var ye,he,Oe=function(t){return function(t){return function(e,n,r){var a,o=function(t,n){e((function(e){var n,r="object"==typeof t?t:t(e);return Ae({},e,r,null==(n=e[fe])?void 0:n.call(e,r))}),n)};r.setState=o;var i=t(o,n,r),s=null==(a=i[fe])?void 0:a.call(i,i);return Object.assign({},i,s)}}(t)},we=((ye={})[exports.GatewayStatus.IN_REVIEW]=J.TOKEN_IN_REVIEW,ye[exports.GatewayStatus.ERROR]=J.ERROR,ye[exports.GatewayStatus.ACTIVE]=J.TOKEN_ACTIVE,ye[exports.GatewayStatus.REVOKED]=J.TOKEN_REVOKED,ye[exports.GatewayStatus.FROZEN]=J.TOKEN_FROZEN,ye[exports.GatewayStatus.REJECTED]=J.TOKEN_REJECTED,ye[exports.GatewayStatus.LOCATION_NOT_SUPPORTED]=J.TOKEN_REJECTED,ye[exports.GatewayStatus.VPN_NOT_SUPPORTED]=J.TOKEN_REJECTED,ye[exports.GatewayStatus.REFRESH_TOKEN_REQUIRED]=J.REFRESH,ye[exports.GatewayStatus.CHECKING]=J.STATUS,ye[exports.GatewayStatus.UNKNOWN]=J.ISSUANCE,ye[exports.GatewayStatus.NOT_REQUESTED]=J.ISSUANCE,ye[exports.GatewayStatus.COLLECTING_USER_INFORMATION]=J.ISSUANCE,ye[exports.GatewayStatus.VALIDATING_USER_INFORMATION]=J.ISSUANCE,ye[exports.GatewayStatus.USER_INFORMATION_VALIDATED]=J.ISSUANCE,ye[exports.GatewayStatus.USER_INFORMATION_REJECTED]=J.ISSUANCE,ye[exports.ExtendedGatewayStatus.USER_VALIDATION_FAILED]=J.ISSUANCE,ye[exports.ExtendedGatewayStatus.ISSUANCE_RESTART_DATA_COLLECTION]=J.ISSUANCE,ye[exports.ExtendedGatewayStatus.ISSUANCE_AWAITING_TRANSACTION_SEND]=J.SIGN_TRANSACTION,ye[exports.ExtendedGatewayStatus.ISSUANCE_AWAITING_THIRD_PARTY_TRANSACTION_SEND]=J.TOKEN_IN_REVIEW,ye[exports.ExtendedGatewayStatus.ISSUANCE_CLIENT_PAYER_REQUESTED]=J.SIGN_TRANSACTION,ye[exports.ExtendedGatewayStatus.ISSUANCE_AWAITING_ON_CHAIN_TOKEN]=J.AWAITING_TRANSACTION_CONFIRMATION,ye[exports.ExtendedGatewayStatus.CONFIRM_OWNER_TRANSACTION]=J.SIGN_TRANSACTION,ye[exports.ExtendedGatewayStatus.AWAITING_OWNER_TRANSACTION]=J.AWAITING_TRANSACTION_CONFIRMATION,ye[exports.ExtendedGatewayStatus.CHAIN_TIMEOUT_ERROR]=J.CHAIN_ERROR,ye[exports.ExtendedGatewayStatus.CHAIN_TRANSACTION_ERROR]=J.CHAIN_ERROR,ye[exports.ExtendedGatewayStatus.CHAIN_SIGN_MESSAGE_ERROR]=J.CHAIN_ERROR,ye[exports.ExtendedGatewayStatus.TOKEN_IN_PARTNER_REVIEW]=J.TOKEN_IN_PARTNER_REVIEW,ye[exports.ExtendedGatewayStatus.TOKEN_REFRESH_IN_REVIEW]=J.TOKEN_REFRESH_IN_REVIEW,ye[exports.ExtendedGatewayStatus.REFRESH_AWAITING_TRANSACTION_SEND]=J.SIGN_TRANSACTION,ye[exports.ExtendedGatewayStatus.REFRESH_CLIENT_PAYER_REQUESTED]=J.SIGN_TRANSACTION,ye[exports.ExtendedGatewayStatus.REFRESH_AWAITING_ON_CHAIN_TOKEN]=J.AWAITING_TRANSACTION_CONFIRMATION,ye[exports.ExtendedGatewayStatus.REFRESH_USER_INFORMATION_VALIDATED]=J.REFRESH,ye[exports.ExtendedGatewayStatus.RESTART]=J.ISSUANCE,ye[exports.ExtendedGatewayStatus.REFRESH_IN_REVIEW]=J.REFRESH,ye[exports.ExtendedGatewayStatus.RESTART_REFRESH]=J.REFRESH,ye[exports.ExtendedGatewayStatus.REFRESH_AWAITING_THIRD_PARTY_TRANSACTION_SEND]=J.TOKEN_REFRESH_IN_REVIEW,ye[exports.ExtendedGatewayStatus.ISSUANCE_CLIENT_SENDS_START_NEW_TX]=J.START_PRE_APPROVED_TRANSACTION,ye[exports.ExtendedGatewayStatus.REFRESH_CLIENT_SENDS_START_NEW_TX]=J.START_PRE_APPROVED_TRANSACTION,ye[exports.ExtendedGatewayStatus.ISSUANCE_CLIENT_SENDS_REQUEST_NEW_TX]=J.SIGN_TRANSACTION,ye[exports.ExtendedGatewayStatus.REFRESH_CLIENT_SENDS_REQUEST_NEW_TX]=J.SIGN_TRANSACTION,ye[exports.ExtendedGatewayStatus.ISSUANCE_CLIENT_THIRD_PARTY_SENDS_REQUEST_NEW_TX]=J.TOKEN_IN_REVIEW,ye[exports.ExtendedGatewayStatus.REFRESH_CLIENT_THIRD_PARTY_SENDS_REQUEST_NEW_TX]=J.TOKEN_REFRESH_IN_REVIEW,ye),Ce=function(t){switch(t){case exports.ExtendedGatewayStatus.AWAITING_OWNER_TRANSACTION:case exports.ExtendedGatewayStatus.CONFIRM_OWNER_TRANSACTION:return exports.GatewayStatus.IN_REVIEW;case exports.ExtendedGatewayStatus.CHAIN_TIMEOUT_ERROR:case exports.ExtendedGatewayStatus.CHAIN_TRANSACTION_ERROR:return exports.GatewayStatus.ERROR;case exports.ExtendedGatewayStatus.TOKEN_IN_PARTNER_REVIEW:case exports.ExtendedGatewayStatus.TOKEN_REFRESH_IN_REVIEW:return exports.GatewayStatus.IN_REVIEW;case exports.ExtendedGatewayStatus.RESTART:return exports.GatewayStatus.NOT_REQUESTED;case exports.ExtendedGatewayStatus.RESTART_REFRESH:return exports.GatewayStatus.REFRESH_TOKEN_REQUIRED;case exports.ExtendedGatewayStatus.USER_VALIDATION_FAILED:return exports.GatewayStatus.USER_INFORMATION_REJECTED;case exports.ExtendedGatewayStatus.CHAIN_SIGN_MESSAGE_ERROR:return exports.GatewayStatus.ERROR;case exports.ExtendedGatewayStatus.ISSUANCE_AWAITING_TRANSACTION_SEND:case exports.ExtendedGatewayStatus.ISSUANCE_AWAITING_ON_CHAIN_TOKEN:return exports.GatewayStatus.IN_REVIEW;case exports.ExtendedGatewayStatus.ISSUANCE_RESTART_DATA_COLLECTION:return exports.GatewayStatus.NOT_REQUESTED;case exports.ExtendedGatewayStatus.ISSUANCE_CLIENT_PAYER_REQUESTED:return exports.GatewayStatus.IN_REVIEW;case exports.ExtendedGatewayStatus.REFRESH_USER_INFORMATION_VALIDATED:return exports.GatewayStatus.USER_INFORMATION_VALIDATED;case exports.ExtendedGatewayStatus.REFRESH_CLIENT_PAYER_REQUESTED:case exports.ExtendedGatewayStatus.REFRESH_IN_REVIEW:case exports.ExtendedGatewayStatus.REFRESH_AWAITING_TRANSACTION_SEND:case exports.ExtendedGatewayStatus.REFRESH_AWAITING_ON_CHAIN_TOKEN:case exports.ExtendedGatewayStatus.ISSUANCE_AWAITING_THIRD_PARTY_TRANSACTION_SEND:case exports.ExtendedGatewayStatus.REFRESH_AWAITING_THIRD_PARTY_TRANSACTION_SEND:return exports.GatewayStatus.IN_REVIEW;case exports.ExtendedGatewayStatus.ISSUANCE_CLIENT_SENDS_START_NEW_TX:case exports.ExtendedGatewayStatus.REFRESH_CLIENT_SENDS_START_NEW_TX:return exports.GatewayStatus.USER_INFORMATION_VALIDATED;case exports.ExtendedGatewayStatus.ISSUANCE_CLIENT_SENDS_REQUEST_NEW_TX:case exports.ExtendedGatewayStatus.ISSUANCE_CLIENT_THIRD_PARTY_SENDS_REQUEST_NEW_TX:case exports.ExtendedGatewayStatus.REFRESH_CLIENT_SENDS_REQUEST_NEW_TX:case exports.ExtendedGatewayStatus.REFRESH_CLIENT_THIRD_PARTY_SENDS_REQUEST_NEW_TX:return exports.GatewayStatus.IN_REVIEW;default:return t}},ge=function(t,e){var n,r,a,o,i,s,u,E,d;return(null===(n=t.inputs.gatewayToken)||void 0===n?void 0:n.received)?Et({gatewayToken:null===(r=t.inputs.gatewayToken)||void 0===r?void 0:r.received,tokenExpirationMarginSeconds:0,forceRequireRefresh:null===(o=null===(a=t.inputs)||void 0===a?void 0:a.dynamicParameters)||void 0===o?void 0:o.forceRequireRefresh})||(null===(i=t.internal.status)||void 0===i?void 0:i.toLowerCase().includes("refresh"))||e.toLowerCase().includes("refresh")||(null===(u=null===(s=t.output)||void 0===s?void 0:s.flowParameters)||void 0===u?void 0:u.flowId.toLowerCase().includes(exports.FlowType.REFRESH.toLowerCase()))?exports.FlowType.REFRESH:(null===(d=null===(E=t.output)||void 0===E?void 0:E.flowParameters)||void 0===d?void 0:d.flowId.toLowerCase().includes(exports.FlowType.ISSUANCE.toLowerCase()))?exports.FlowType.ISSUANCE:exports.FlowType.STATUS:[exports.GatewayStatus.CHECKING,exports.GatewayStatus.UNKNOWN].includes(e)?exports.FlowType.STATUS:exports.FlowType.ISSUANCE},xe=[exports.GatewayStatus.REFRESH_TOKEN_REQUIRED,exports.GatewayStatus.FROZEN,exports.GatewayStatus.REVOKED,exports.GatewayStatus.ERROR],Ge=[exports.GatewayStatus.ACTIVE,exports.GatewayStatus.REFRESH_TOKEN_REQUIRED,exports.GatewayStatus.FROZEN,exports.GatewayStatus.REVOKED,exports.GatewayStatus.ERROR],De=function(t){var e,n,r,a,o,i,s;if((null===(e=t.inputs.civicPass.received)||void 0===e?void 0:e.event)===Y.FAILURE&&(null===(n=t.inputs.civicPass.received)||void 0===n?void 0:n.action)===J.CHAIN_ERROR){var u=!!(null===(r=t.inputs.gatewayToken)||void 0===r?void 0:r.received);return(null===(a=t.internal.chainTransaction)||void 0===a?void 0:a.error)&&(t.internal.chainTransaction.attempts||0)<=((null===(i=null===(o=t.inputs.parameters)||void 0===o?void 0:o.options)||void 0===i?void 0:i.clientSendsMaxRetries)||3)?u?Nt(t)?exports.ExtendedGatewayStatus.REFRESH_AWAITING_TRANSACTION_SEND:exports.ExtendedGatewayStatus.REFRESH_AWAITING_THIRD_PARTY_TRANSACTION_SEND:Nt(t)?exports.ExtendedGatewayStatus.ISSUANCE_AWAITING_TRANSACTION_SEND:exports.ExtendedGatewayStatus.ISSUANCE_AWAITING_THIRD_PARTY_TRANSACTION_SEND:u?Nt(t)?exports.ExtendedGatewayStatus.REFRESH_CLIENT_SENDS_REQUEST_NEW_TX:exports.ExtendedGatewayStatus.REFRESH_CLIENT_THIRD_PARTY_SENDS_REQUEST_NEW_TX:Nt(t)?exports.ExtendedGatewayStatus.ISSUANCE_CLIENT_SENDS_REQUEST_NEW_TX:exports.ExtendedGatewayStatus.ISSUANCE_CLIENT_THIRD_PARTY_SENDS_REQUEST_NEW_TX}return null===(s=t.internal)||void 0===s?void 0:s.status},me=function(t){var e,n,r;return(null===(n=null===(e=null==t?void 0:t.received)||void 0===e?void 0:e.payload)||void 0===n?void 0:n.pending)||(null===(r=null==t?void 0:t.received)||void 0===r?void 0:r.pending)},Ue=function(t){var e;return(null==t?void 0:t.action)===J.STATUS&&(null==t?void 0:t.event)===Y.SUCCESS&&(null===(e=t.payload)||void 0===e?void 0:e.status)!==z.NOT_FOUND||(null==t?void 0:t.action)===J.ISSUANCE&&(null==t?void 0:t.event)===Y.IN_PROGRESS},be=function(t){return!!me(t)},Pe=function(t){var e,n;return!!(null===(n=null===(e=null==t?void 0:t.received)||void 0===e?void 0:e.payload)||void 0===n?void 0:n.preApprovedTxAvailable)},Fe=function(t){var e;return vt(t)||ft(t)||function(t){var e,n,r,a,o,i,s,u,E=null===(e=t.inputs.civicPass)||void 0===e?void 0:e.received,d=t.inputs.gatekeeperRecord;return(null==d?void 0:d.status)===et.IN_PROGRESS?t.internal.status:be(d)?exports.ExtendedGatewayStatus.TOKEN_IN_PARTNER_REVIEW:(null===(n=t.inputs.parameters)||void 0===n?void 0:n.payer)?(null==d?void 0:d.status)!==et.COMPLETE||(null==E?void 0:E.action)===J.ISSUANCE||(null===(r=d.received)||void 0===r?void 0:r.transaction)?(null===(o=null===(a=t.internal)||void 0===a?void 0:a.chainTransaction)||void 0===o?void 0:o.sentTxId)?exports.ExtendedGatewayStatus.ISSUANCE_AWAITING_ON_CHAIN_TOKEN:(null===(s=null===(i=t.internal)||void 0===i?void 0:i.chainTransaction)||void 0===s?void 0:s.error)?exports.ExtendedGatewayStatus.CHAIN_TRANSACTION_ERROR:(null===(u=d.received)||void 0===u?void 0:u.transaction)?Nt(t)?exports.ExtendedGatewayStatus.ISSUANCE_AWAITING_TRANSACTION_SEND:exports.ExtendedGatewayStatus.ISSUANCE_AWAITING_THIRD_PARTY_TRANSACTION_SEND:void 0:exports.ExtendedGatewayStatus.ISSUANCE_RESTART_DATA_COLLECTION:exports.ExtendedGatewayStatus.ISSUANCE_AWAITING_ON_CHAIN_TOKEN}(t)||(null===(e=t.internal)||void 0===e?void 0:e.status)},ke=function(t){var e;return vt(t)||function(t){var e,n,r,a,o,i,s=null===(e=t.inputs.civicPass)||void 0===e?void 0:e.received,u=t.inputs.gatekeeperRecord;if((null==s?void 0:s.event)===Y.FAILURE)return exports.ExtendedGatewayStatus.USER_VALIDATION_FAILED;if((null==s?void 0:s.action)===J.ISSUANCE&&(null==s?void 0:s.event)===Y.SUCCESS)return exports.GatewayStatus.USER_INFORMATION_VALIDATED;if(!(null==u?void 0:u.received)||(null===(n=null==u?void 0:u.received)||void 0===n?void 0:n.state)===l.NOT_REQUESTED){if(Ue(s)){var E=Tt[null===(r=null==s?void 0:s.payload)||void 0===r?void 0:r.status];return E===exports.GatewayStatus.USER_INFORMATION_VALIDATED?exports.GatewayStatus.NOT_REQUESTED:E||exports.GatewayStatus.COLLECTING_USER_INFORMATION}return exports.GatewayStatus.NOT_REQUESTED}if((null===(a=null==u?void 0:u.received)||void 0===a?void 0:a.state)===l.REQUESTED){if(Pe(u))return Nt(t)?exports.ExtendedGatewayStatus.ISSUANCE_CLIENT_SENDS_START_NEW_TX:exports.ExtendedGatewayStatus.ISSUANCE_CLIENT_THIRD_PARTY_SENDS_REQUEST_NEW_TX;if(be(u))return exports.ExtendedGatewayStatus.TOKEN_IN_PARTNER_REVIEW;if(!(null===(o=t.inputs.parameters)||void 0===o?void 0:o.payer))return exports.ExtendedGatewayStatus.ISSUANCE_AWAITING_ON_CHAIN_TOKEN;if((null==u?void 0:u.status)===et.COMPLETE&&(null==s?void 0:s.action)!==J.ISSUANCE&&!(null===(i=u.received)||void 0===i?void 0:i.transaction))return exports.ExtendedGatewayStatus.ISSUANCE_RESTART_DATA_COLLECTION}}(t)||(null===(e=t.internal)||void 0===e?void 0:e.status)},Le=function(t){if(!t.inputs.civicPass.status||function(t){var e,n,r;return!((null===(e=t.inputs.civicPass.received)||void 0===e?void 0:e.action)!==J.STATUS||t.inputs.gatewayToken.status&&t.inputs.gatewayToken.status!==et.IN_PROGRESS&&((null===(n=t.inputs.parameters)||void 0===n?void 0:n.disableInitialGatekeeperLookup)||t.inputs.gatekeeperRecord.status&&(null===(r=t.inputs.gatekeeperRecord)||void 0===r?void 0:r.status)!==et.IN_PROGRESS))}(t)){if(t.inputs.gatekeeperRecord.status===et.ERROR||t.inputs.gatewayToken.status===et.ERROR)return exports.GatewayStatus.ERROR;if(t.inputs.gatekeeperRecord.status===et.IN_PROGRESS||t.inputs.gatewayToken.status===et.IN_PROGRESS)return exports.GatewayStatus.CHECKING}},He=function(t){var e=vt(t);return e&&![exports.ExtendedGatewayStatus.REFRESH_AWAITING_ON_CHAIN_TOKEN,exports.GatewayStatus.REFRESH_TOKEN_REQUIRED].includes(e)?e:void 0},We=function(t){var e;return He(t)||ft(t)||function(t){var e,n,r,a,o,i,s=t.inputs.gatekeeperRecord;return(null===(e=t.inputs.parameters)||void 0===e?void 0:e.payer)?(null===(r=null===(n=t.internal)||void 0===n?void 0:n.chainTransaction)||void 0===r?void 0:r.sentTxId)?exports.ExtendedGatewayStatus.REFRESH_AWAITING_ON_CHAIN_TOKEN:(null===(o=null===(a=t.internal)||void 0===a?void 0:a.chainTransaction)||void 0===o?void 0:o.error)?exports.ExtendedGatewayStatus.CHAIN_TRANSACTION_ERROR:(null===(i=s.received)||void 0===i?void 0:i.transaction)?Nt(t)?exports.ExtendedGatewayStatus.REFRESH_AWAITING_TRANSACTION_SEND:exports.ExtendedGatewayStatus.REFRESH_AWAITING_THIRD_PARTY_TRANSACTION_SEND:void 0:exports.ExtendedGatewayStatus.REFRESH_AWAITING_ON_CHAIN_TOKEN}(t)||(null===(e=t.internal)||void 0===e?void 0:e.status)},Me=y("gatewayStatus").debug,Ve=y("gatewayStatus").error,Ke=[exports.GatewayStatus.ACTIVE,exports.GatewayStatus.FROZEN,exports.GatewayStatus.REVOKED,exports.GatewayStatus.REFRESH_TOKEN_REQUIRED],Qe=[exports.GatewayStatus.COLLECTING_USER_INFORMATION,exports.GatewayStatus.VALIDATING_USER_INFORMATION,exports.GatewayStatus.USER_INFORMATION_REJECTED,exports.GatewayStatus.USER_INFORMATION_VALIDATED],je=[exports.GatewayStatus.REJECTED,exports.GatewayStatus.ERROR,exports.GatewayStatus.LOCATION_NOT_SUPPORTED,exports.GatewayStatus.VPN_NOT_SUPPORTED];function qe(t,e){return{nextState:t,compute:e}}var Xe=((he={})[exports.GatewayStatus.UNKNOWN]=qe(o(o([],Ke,!0),[exports.GatewayStatus.CHECKING],!1),(function(t){var e;return vt(t)||Le(t)||(null===(e=t.internal)||void 0===e?void 0:e.status)})),he[exports.GatewayStatus.CHECKING]=qe(o(o(o(o([],Ke,!0),je,!0),Qe,!0),[exports.GatewayStatus.NOT_REQUESTED,exports.ExtendedGatewayStatus.ISSUANCE_RESTART_DATA_COLLECTION,exports.ExtendedGatewayStatus.TOKEN_IN_PARTNER_REVIEW,exports.ExtendedGatewayStatus.ISSUANCE_CLIENT_SENDS_START_NEW_TX,exports.ExtendedGatewayStatus.ISSUANCE_CLIENT_THIRD_PARTY_SENDS_REQUEST_NEW_TX,exports.ExtendedGatewayStatus.REFRESH_CLIENT_SENDS_START_NEW_TX,exports.ExtendedGatewayStatus.REFRESH_CLIENT_THIRD_PARTY_SENDS_REQUEST_NEW_TX],!1),(function(t){var e;return Le(t)||ft(t)||vt(t)||ke(t)||(null===(e=t.internal)||void 0===e?void 0:e.status)})),he[exports.GatewayStatus.NOT_REQUESTED]=qe(o(o(o([],Ke,!0),Qe,!0),[exports.ExtendedGatewayStatus.TOKEN_IN_PARTNER_REVIEW,exports.ExtendedGatewayStatus.ISSUANCE_AWAITING_ON_CHAIN_TOKEN,exports.GatewayStatus.NOT_REQUESTED,exports.ExtendedGatewayStatus.RESTART,exports.ExtendedGatewayStatus.ISSUANCE_RESTART_DATA_COLLECTION],!1),ke),he[exports.GatewayStatus.COLLECTING_USER_INFORMATION]=qe(o(o(o([],Ke,!0),Qe,!0),[exports.ExtendedGatewayStatus.TOKEN_IN_PARTNER_REVIEW,exports.ExtendedGatewayStatus.ISSUANCE_AWAITING_ON_CHAIN_TOKEN,exports.GatewayStatus.NOT_REQUESTED,exports.ExtendedGatewayStatus.RESTART,exports.ExtendedGatewayStatus.ISSUANCE_RESTART_DATA_COLLECTION,exports.ExtendedGatewayStatus.USER_VALIDATION_FAILED],!1),ke),he[exports.GatewayStatus.USER_INFORMATION_VALIDATED]=qe(o(o([],Ke,!0),[exports.ExtendedGatewayStatus.ISSUANCE_CLIENT_PAYER_REQUESTED,exports.GatewayStatus.IN_REVIEW],!1),(function(t){var e;return vt(t)||function(t){var e,n,r,a=null===(e=t.inputs.civicPass)||void 0===e?void 0:e.received,o=t.inputs.gatekeeperRecord;if(a&&((null===(n=null==o?void 0:o.received)||void 0===n?void 0:n.state)===l.REQUESTED||(null==o?void 0:o.status)===et.IN_PROGRESS))return(null===(r=t.inputs.parameters)||void 0===r?void 0:r.payer)&&Nt(t)?exports.ExtendedGatewayStatus.ISSUANCE_CLIENT_PAYER_REQUESTED:exports.GatewayStatus.IN_REVIEW}(t)||(null===(e=t.internal)||void 0===e?void 0:e.status)})),he[exports.ExtendedGatewayStatus.ISSUANCE_CLIENT_PAYER_REQUESTED]=qe(o(o(o([],Ke,!0),je,!0),[exports.ExtendedGatewayStatus.ISSUANCE_RESTART_DATA_COLLECTION,exports.ExtendedGatewayStatus.ISSUANCE_AWAITING_TRANSACTION_SEND,exports.ExtendedGatewayStatus.ISSUANCE_AWAITING_THIRD_PARTY_TRANSACTION_SEND,exports.ExtendedGatewayStatus.ISSUANCE_AWAITING_ON_CHAIN_TOKEN,exports.ExtendedGatewayStatus.TOKEN_IN_PARTNER_REVIEW],!1),Fe),he[exports.GatewayStatus.IN_REVIEW]=qe(o(o(o([],Ke,!0),je,!0),[exports.ExtendedGatewayStatus.ISSUANCE_AWAITING_TRANSACTION_SEND,exports.ExtendedGatewayStatus.ISSUANCE_AWAITING_THIRD_PARTY_TRANSACTION_SEND,exports.ExtendedGatewayStatus.ISSUANCE_AWAITING_ON_CHAIN_TOKEN,exports.ExtendedGatewayStatus.TOKEN_IN_PARTNER_REVIEW],!1),Fe),he[exports.GatewayStatus.REJECTED]=qe([],(function(){return exports.GatewayStatus.REJECTED})),he[exports.ExtendedGatewayStatus.ISSUANCE_AWAITING_TRANSACTION_SEND]=qe(o(o([],Ke,!0),[exports.ExtendedGatewayStatus.ISSUANCE_AWAITING_ON_CHAIN_TOKEN,exports.ExtendedGatewayStatus.CONFIRM_OWNER_TRANSACTION,exports.ExtendedGatewayStatus.CHAIN_TRANSACTION_ERROR],!1),Fe),he[exports.ExtendedGatewayStatus.ISSUANCE_AWAITING_THIRD_PARTY_TRANSACTION_SEND]=qe(o(o([],Ke,!0),[exports.ExtendedGatewayStatus.ISSUANCE_AWAITING_ON_CHAIN_TOKEN,exports.ExtendedGatewayStatus.CONFIRM_OWNER_TRANSACTION,exports.ExtendedGatewayStatus.CHAIN_TRANSACTION_ERROR],!1),Fe),he[exports.ExtendedGatewayStatus.ISSUANCE_AWAITING_ON_CHAIN_TOKEN]=qe(o(o([],Ke,!0),[exports.ExtendedGatewayStatus.CHAIN_TIMEOUT_ERROR],!1),(function(t){var e;return vt(t)||function(t){var e,n;if((null===(n=null===(e=t.internal.errors)||void 0===e?void 0:e.expectedOnChainToken)||void 0===n?void 0:n.errorCode)===k.CHAIN_CONFIRMATION_TIMEOUT_ERROR)return exports.ExtendedGatewayStatus.CHAIN_TIMEOUT_ERROR}(t)||(null===(e=t.internal)||void 0===e?void 0:e.status)})),he[exports.ExtendedGatewayStatus.ISSUANCE_RESTART_DATA_COLLECTION]=qe(o(o(o([],Ke,!0),Qe,!0),[exports.GatewayStatus.USER_INFORMATION_VALIDATED,exports.ExtendedGatewayStatus.ISSUANCE_CLIENT_PAYER_REQUESTED,exports.GatewayStatus.NOT_REQUESTED],!1),(function(t){var e;return vt(t)||function(t){var e,n,r=null===(e=t.inputs.civicPass)||void 0===e?void 0:e.received;if((null==r?void 0:r.event)===Y.FAILURE)return exports.ExtendedGatewayStatus.USER_VALIDATION_FAILED;var a=Tt[null===(n=null==r?void 0:r.payload)||void 0===n?void 0:n.status];return(null==r?void 0:r.action)===J.STATUS&&(null==r?void 0:r.event)===Y.SUCCESS&&a?a===exports.GatewayStatus.USER_INFORMATION_VALIDATED?r.payload?exports.GatewayStatus.USER_INFORMATION_VALIDATED:exports.GatewayStatus.NOT_REQUESTED:a:(null==r?void 0:r.action)===J.ISSUANCE&&(null==r?void 0:r.event)===Y.SUCCESS?exports.GatewayStatus.USER_INFORMATION_VALIDATED:Ue(r)?a||exports.GatewayStatus.COLLECTING_USER_INFORMATION:void 0}(t)||(null===(e=t.internal)||void 0===e?void 0:e.status)})),he[exports.GatewayStatus.REVOKED]=qe([],At),he[exports.GatewayStatus.FROZEN]=qe(o([],Ke,!0),At),he[exports.GatewayStatus.ACTIVE]=qe(o([],Ke,!0),At),he[exports.GatewayStatus.ERROR]=qe(o(o([],Ke,!0),[exports.ExtendedGatewayStatus.RESTART,exports.ExtendedGatewayStatus.RESTART_REFRESH],!1),(function(t){var e,n,r,a=!!t.inputs.gatewayToken.received;return(null===(e=t.inputs.civicPass.received)||void 0===e?void 0:e.event)===Y.FAILURE&&(null===(n=t.inputs.civicPass.received)||void 0===n?void 0:n.action)===J.ERROR?a?exports.ExtendedGatewayStatus.RESTART_REFRESH:exports.ExtendedGatewayStatus.RESTART:null===(r=t.internal)||void 0===r?void 0:r.status})),he[exports.GatewayStatus.LOCATION_NOT_SUPPORTED]=qe([],(function(){return exports.GatewayStatus.LOCATION_NOT_SUPPORTED})),he[exports.GatewayStatus.VPN_NOT_SUPPORTED]=qe([],(function(){return exports.GatewayStatus.VPN_NOT_SUPPORTED})),he[exports.ExtendedGatewayStatus.USER_VALIDATION_FAILED]=qe([exports.ExtendedGatewayStatus.USER_VALIDATION_FAILED,exports.ExtendedGatewayStatus.RESTART],(function(t){var e,n;return(null===(n=null===(e=t.inputs.parameters)||void 0===e?void 0:e.options)||void 0===n?void 0:n.disableAutoRestartOnValidationFailure)?exports.ExtendedGatewayStatus.USER_VALIDATION_FAILED:exports.ExtendedGatewayStatus.RESTART})),he[exports.GatewayStatus.REFRESH_TOKEN_REQUIRED]=qe(o(o([],Ke,!0),[exports.ExtendedGatewayStatus.REFRESH_USER_INFORMATION_VALIDATED,exports.ExtendedGatewayStatus.REFRESH_CLIENT_SENDS_START_NEW_TX],!1),(function(t){var e;return He(t)||ft(t)||function(t){var e,n=null===(e=t.inputs.civicPass)||void 0===e?void 0:e.received;return Pe(t.inputs.gatekeeperRecord)?Nt(t)?exports.ExtendedGatewayStatus.REFRESH_CLIENT_SENDS_START_NEW_TX:exports.ExtendedGatewayStatus.REFRESH_CLIENT_THIRD_PARTY_SENDS_REQUEST_NEW_TX:(null==n?void 0:n.action)===J.REFRESH&&(null==n?void 0:n.event)===Y.SUCCESS?exports.ExtendedGatewayStatus.REFRESH_USER_INFORMATION_VALIDATED:void 0}(t)||(null===(e=t.internal)||void 0===e?void 0:e.status)})),he[exports.ExtendedGatewayStatus.REFRESH_USER_INFORMATION_VALIDATED]=qe(o(o([],Ke,!0),[exports.ExtendedGatewayStatus.REFRESH_CLIENT_PAYER_REQUESTED,exports.ExtendedGatewayStatus.REFRESH_IN_REVIEW],!1),(function(t){var e;return He(t)||function(t){var e,n,r=t.inputs.gatekeeperRecord;if((null===(e=null==r?void 0:r.received)||void 0===e?void 0:e.state)===l.REQUESTED||(null==r?void 0:r.status)===et.IN_PROGRESS)return(null===(n=t.inputs.parameters)||void 0===n?void 0:n.payer)&&Nt(t)?exports.ExtendedGatewayStatus.REFRESH_CLIENT_PAYER_REQUESTED:exports.ExtendedGatewayStatus.REFRESH_IN_REVIEW}(t)||(null===(e=t.internal)||void 0===e?void 0:e.status)})),he[exports.ExtendedGatewayStatus.REFRESH_IN_REVIEW]=qe(o(o(o([],Ke,!0),je,!0),[exports.ExtendedGatewayStatus.REFRESH_AWAITING_TRANSACTION_SEND,exports.ExtendedGatewayStatus.REFRESH_AWAITING_THIRD_PARTY_TRANSACTION_SEND,exports.ExtendedGatewayStatus.REFRESH_AWAITING_ON_CHAIN_TOKEN],!1),We),he[exports.ExtendedGatewayStatus.TOKEN_REFRESH_IN_REVIEW]=qe(o(o(o([],Ke,!0),je,!0),[exports.ExtendedGatewayStatus.REFRESH_AWAITING_TRANSACTION_SEND,exports.ExtendedGatewayStatus.REFRESH_AWAITING_THIRD_PARTY_TRANSACTION_SEND,exports.ExtendedGatewayStatus.REFRESH_AWAITING_ON_CHAIN_TOKEN],!1),We),he[exports.ExtendedGatewayStatus.REFRESH_CLIENT_PAYER_REQUESTED]=qe(o(o(o([],Ke,!0),je,!0),[exports.ExtendedGatewayStatus.REFRESH_AWAITING_TRANSACTION_SEND,exports.ExtendedGatewayStatus.REFRESH_AWAITING_THIRD_PARTY_TRANSACTION_SEND,exports.ExtendedGatewayStatus.REFRESH_AWAITING_ON_CHAIN_TOKEN],!1),We),he[exports.ExtendedGatewayStatus.REFRESH_AWAITING_TRANSACTION_SEND]=qe(o(o([],Ke,!0),[exports.ExtendedGatewayStatus.REFRESH_AWAITING_ON_CHAIN_TOKEN,exports.ExtendedGatewayStatus.CONFIRM_OWNER_TRANSACTION,exports.ExtendedGatewayStatus.CHAIN_TRANSACTION_ERROR],!1),We),he[exports.ExtendedGatewayStatus.REFRESH_AWAITING_THIRD_PARTY_TRANSACTION_SEND]=qe(o(o([],Ke,!0),[exports.ExtendedGatewayStatus.REFRESH_AWAITING_ON_CHAIN_TOKEN,exports.ExtendedGatewayStatus.CONFIRM_OWNER_TRANSACTION,exports.ExtendedGatewayStatus.CHAIN_TRANSACTION_ERROR],!1),We),he[exports.ExtendedGatewayStatus.REFRESH_AWAITING_ON_CHAIN_TOKEN]=qe(o(o(o([],Ke,!0),je,!0),[exports.ExtendedGatewayStatus.CHAIN_TIMEOUT_ERROR],!1),(function(t){var e;return He(t)||ft(t)||function(t){var e,n;if((null===(n=null===(e=t.internal.errors)||void 0===e?void 0:e.expectedOnChainToken)||void 0===n?void 0:n.errorCode)===k.CHAIN_CONFIRMATION_TIMEOUT_ERROR)return exports.ExtendedGatewayStatus.CHAIN_TIMEOUT_ERROR}(t)||(null===(e=t.internal)||void 0===e?void 0:e.status)})),he[exports.ExtendedGatewayStatus.CHAIN_TIMEOUT_ERROR]=qe(o(o([],Ke,!0),[exports.GatewayStatus.USER_INFORMATION_VALIDATED,exports.ExtendedGatewayStatus.RESTART,exports.ExtendedGatewayStatus.RESTART_REFRESH,exports.ExtendedGatewayStatus.ISSUANCE_CLIENT_SENDS_REQUEST_NEW_TX,exports.ExtendedGatewayStatus.ISSUANCE_CLIENT_THIRD_PARTY_SENDS_REQUEST_NEW_TX,exports.ExtendedGatewayStatus.REFRESH_CLIENT_SENDS_REQUEST_NEW_TX,exports.ExtendedGatewayStatus.REFRESH_CLIENT_THIRD_PARTY_SENDS_REQUEST_NEW_TX],!1),De),he[exports.ExtendedGatewayStatus.CHAIN_TRANSACTION_ERROR]=qe(o(o([],Ke,!0),[exports.ExtendedGatewayStatus.RESTART,exports.ExtendedGatewayStatus.RESTART_REFRESH,exports.ExtendedGatewayStatus.ISSUANCE_AWAITING_TRANSACTION_SEND,exports.ExtendedGatewayStatus.ISSUANCE_AWAITING_THIRD_PARTY_TRANSACTION_SEND,exports.ExtendedGatewayStatus.REFRESH_AWAITING_ON_CHAIN_TOKEN,exports.ExtendedGatewayStatus.ISSUANCE_CLIENT_SENDS_REQUEST_NEW_TX,exports.ExtendedGatewayStatus.ISSUANCE_CLIENT_THIRD_PARTY_SENDS_REQUEST_NEW_TX,exports.ExtendedGatewayStatus.REFRESH_CLIENT_SENDS_REQUEST_NEW_TX,exports.ExtendedGatewayStatus.REFRESH_CLIENT_THIRD_PARTY_SENDS_REQUEST_NEW_TX,exports.ExtendedGatewayStatus.REFRESH_AWAITING_TRANSACTION_SEND],!1),De),he[exports.ExtendedGatewayStatus.TOKEN_IN_PARTNER_REVIEW]=qe(o(o(o([],Ke,!0),je,!0),[exports.ExtendedGatewayStatus.ISSUANCE_AWAITING_ON_CHAIN_TOKEN],!1),Fe),he[exports.ExtendedGatewayStatus.RESTART]=qe([exports.ExtendedGatewayStatus.RESTART],(function(){return exports.ExtendedGatewayStatus.RESTART})),he[exports.ExtendedGatewayStatus.RESTART_REFRESH]=qe([exports.ExtendedGatewayStatus.RESTART_REFRESH],(function(){return exports.ExtendedGatewayStatus.RESTART_REFRESH})),he[exports.ExtendedGatewayStatus.CHAIN_SIGN_MESSAGE_ERROR]=qe([exports.ExtendedGatewayStatus.RESTART,exports.ExtendedGatewayStatus.RESTART_REFRESH,exports.ExtendedGatewayStatus.ISSUANCE_CLIENT_SENDS_REQUEST_NEW_TX,exports.ExtendedGatewayStatus.ISSUANCE_CLIENT_THIRD_PARTY_SENDS_REQUEST_NEW_TX,exports.ExtendedGatewayStatus.REFRESH_CLIENT_SENDS_REQUEST_NEW_TX,exports.ExtendedGatewayStatus.REFRESH_CLIENT_THIRD_PARTY_SENDS_REQUEST_NEW_TX],De),he[exports.GatewayStatus.VALIDATING_USER_INFORMATION]=qe(o(o(o([],Ke,!0),Qe,!0),[exports.ExtendedGatewayStatus.TOKEN_IN_PARTNER_REVIEW,exports.ExtendedGatewayStatus.RESTART,exports.ExtendedGatewayStatus.ISSUANCE_AWAITING_ON_CHAIN_TOKEN,exports.ExtendedGatewayStatus.ISSUANCE_RESTART_DATA_COLLECTION,exports.GatewayStatus.NOT_REQUESTED],!1),ke),he[exports.GatewayStatus.USER_INFORMATION_REJECTED]=qe(o(o(o([],Ke,!0),Qe,!0),[exports.ExtendedGatewayStatus.TOKEN_IN_PARTNER_REVIEW,exports.ExtendedGatewayStatus.RESTART,exports.ExtendedGatewayStatus.ISSUANCE_AWAITING_ON_CHAIN_TOKEN,exports.ExtendedGatewayStatus.ISSUANCE_RESTART_DATA_COLLECTION,exports.GatewayStatus.NOT_REQUESTED],!1),ke),he[exports.ExtendedGatewayStatus.AWAITING_OWNER_TRANSACTION]=qe([],(function(){return exports.ExtendedGatewayStatus.AWAITING_OWNER_TRANSACTION})),he[exports.ExtendedGatewayStatus.CONFIRM_OWNER_TRANSACTION]=qe([],(function(){return exports.ExtendedGatewayStatus.CONFIRM_OWNER_TRANSACTION})),he[exports.ExtendedGatewayStatus.ISSUANCE_CLIENT_SENDS_START_NEW_TX]=qe(o(o([],Ke,!0),[exports.ExtendedGatewayStatus.ISSUANCE_CLIENT_SENDS_REQUEST_NEW_TX,exports.ExtendedGatewayStatus.ISSUANCE_CLIENT_THIRD_PARTY_SENDS_REQUEST_NEW_TX],!1),(function(t){var e;return vt(t)||function(t){var e,n=null===(e=t.inputs.civicPass)||void 0===e?void 0:e.received;if((null==n?void 0:n.action)===J.START_PRE_APPROVED_TRANSACTION&&(null==n?void 0:n.event)===Y.SUCCESS&&void 0!==(null==n?void 0:n.payload))return Nt(t)?exports.ExtendedGatewayStatus.ISSUANCE_CLIENT_SENDS_REQUEST_NEW_TX:exports.ExtendedGatewayStatus.ISSUANCE_CLIENT_THIRD_PARTY_SENDS_REQUEST_NEW_TX}(t)||(null===(e=t.internal)||void 0===e?void 0:e.status)})),he[exports.ExtendedGatewayStatus.ISSUANCE_CLIENT_SENDS_REQUEST_NEW_TX]=qe(o(o(o([],Ke,!0),je,!0),[exports.ExtendedGatewayStatus.ISSUANCE_RESTART_DATA_COLLECTION,exports.ExtendedGatewayStatus.ISSUANCE_AWAITING_TRANSACTION_SEND,exports.ExtendedGatewayStatus.ISSUANCE_AWAITING_THIRD_PARTY_TRANSACTION_SEND,exports.ExtendedGatewayStatus.ISSUANCE_AWAITING_ON_CHAIN_TOKEN,exports.ExtendedGatewayStatus.TOKEN_IN_PARTNER_REVIEW,exports.ExtendedGatewayStatus.CHAIN_TRANSACTION_ERROR],!1),Fe),he[exports.ExtendedGatewayStatus.ISSUANCE_CLIENT_THIRD_PARTY_SENDS_REQUEST_NEW_TX]=qe(o(o(o([],Ke,!0),je,!0),[exports.ExtendedGatewayStatus.ISSUANCE_RESTART_DATA_COLLECTION,exports.ExtendedGatewayStatus.ISSUANCE_AWAITING_TRANSACTION_SEND,exports.ExtendedGatewayStatus.ISSUANCE_AWAITING_THIRD_PARTY_TRANSACTION_SEND,exports.ExtendedGatewayStatus.ISSUANCE_AWAITING_ON_CHAIN_TOKEN,exports.ExtendedGatewayStatus.TOKEN_IN_PARTNER_REVIEW,exports.ExtendedGatewayStatus.CHAIN_TRANSACTION_ERROR],!1),Fe),he[exports.ExtendedGatewayStatus.REFRESH_CLIENT_SENDS_START_NEW_TX]=qe(o(o([],Ke,!0),[exports.ExtendedGatewayStatus.REFRESH_CLIENT_SENDS_REQUEST_NEW_TX,exports.ExtendedGatewayStatus.REFRESH_CLIENT_THIRD_PARTY_SENDS_REQUEST_NEW_TX],!1),(function(t){var e;return He(t)||function(t){var e,n=null===(e=t.inputs.civicPass)||void 0===e?void 0:e.received;if((null==n?void 0:n.action)===J.START_PRE_APPROVED_TRANSACTION&&(null==n?void 0:n.event)===Y.SUCCESS&&void 0!==(null==n?void 0:n.payload))return Nt(t)?exports.ExtendedGatewayStatus.REFRESH_CLIENT_SENDS_REQUEST_NEW_TX:exports.ExtendedGatewayStatus.REFRESH_CLIENT_THIRD_PARTY_SENDS_REQUEST_NEW_TX}(t)||(null===(e=t.internal)||void 0===e?void 0:e.status)})),he[exports.ExtendedGatewayStatus.REFRESH_CLIENT_SENDS_REQUEST_NEW_TX]=qe(o(o(o([],Ke,!0),je,!0),[exports.ExtendedGatewayStatus.REFRESH_AWAITING_TRANSACTION_SEND,exports.ExtendedGatewayStatus.REFRESH_AWAITING_THIRD_PARTY_TRANSACTION_SEND,exports.ExtendedGatewayStatus.REFRESH_AWAITING_ON_CHAIN_TOKEN],!1),We),he[exports.ExtendedGatewayStatus.REFRESH_CLIENT_THIRD_PARTY_SENDS_REQUEST_NEW_TX]=qe(o(o(o([],Ke,!0),je,!0),[exports.ExtendedGatewayStatus.REFRESH_AWAITING_TRANSACTION_SEND,exports.ExtendedGatewayStatus.REFRESH_AWAITING_THIRD_PARTY_TRANSACTION_SEND,exports.ExtendedGatewayStatus.REFRESH_AWAITING_ON_CHAIN_TOKEN],!1),We),he),Ye=function(t){var e,n,r=null===(e=t.internal)||void 0===e?void 0:e.status,a=null===(n=Xe[r])||void 0===n?void 0:n.compute;if(!a)throw new Error("No transition function defined for ".concat(r," status"));var o=a(t);if(o===r)return r;if(!function(t,e){var n;return null===(n=Xe[t])||void 0===n?void 0:n.nextState.includes(e)}(r,o))throw Ve("Invalid transition, throwing an error...",{currentStatus:r,computedStatus:o}),new Error("Invalid transition, returning currentStatus currentStatus: ".concat(r," computedStatus: ").concat(o));return Me("Transitioning to new status",{currentStatus:r,computedStatus:o}),o},Je="@civic/gateway-client-core:1.1.1-beta.1",ze=function(t,e){var r,a,o,i,s,u,E,d,c,l,S,p,_,R,T,N,I,v,A,f,y,h,O,w,C,g,x,G,D,m;if(!((null===(r=t.inputs.parameters)||void 0===r?void 0:r.wallet)&&(null===(a=t.internal.chainDetails)||void 0===a?void 0:a.chainType)&&(null===(o=t.internal)||void 0===o?void 0:o.instanceId))||[exports.GatewayStatus.UNKNOWN,exports.GatewayStatus.CHECKING].includes(e))return null;var U,b=(null===(s=null===(i=t.internal.errors)||void 0===i?void 0:i.expectedTokenGatekeeperRecord)||void 0===s?void 0:s.errorCode)||(null===(E=null===(u=t.internal.chainTransaction)||void 0===u?void 0:u.error)||void 0===E?void 0:E.errorCode)||(null===(c=null===(d=t.inputs.gatekeeperRecord)||void 0===d?void 0:d.received)||void 0===c?void 0:c.errorCode)||(null===(p=null===(S=null===(l=t.inputs.gatekeeperRecord)||void 0===l?void 0:l.received)||void 0===S?void 0:S.payload)||void 0===p?void 0:p.errorCode)||(null===(R=null===(_=t.inputs.civicSign)||void 0===_?void 0:_.error)||void 0===R?void 0:R.errorCode),P=we[e],F=function(t,e){var n,r,a,o=null===(r=null===(n=t.output)||void 0===n?void 0:n.flowParameters)||void 0===r?void 0:r.flowId,i=ge(t,e),s="".concat(i,"_");return o&&""!==o&&o.includes(s)?o:"".concat((null===(a=t.inputs.parameters)||void 0===a?void 0:a.flowIdPrefix)||"GWC","_").concat(s).concat(tt())}(t,e),k=null==(U=null===(N=null===(T=t.inputs.gatekeeperRecord)||void 0===T?void 0:T.received)||void 0===N?void 0:N.payload)||0===Object.keys(U).length?void 0:JSON.stringify(null===(v=null===(I=t.inputs.gatekeeperRecord)||void 0===I?void 0:I.received)||void 0===v?void 0:v.payload),L=!t.inputs.parameters.gatekeeperSendsTransaction&&Nt(t);return n(n({action:P,flowId:F,ownerSigns:L,errorCode:b,flowType:ge(t,e)},k?{payload:k}:{}),{redirectUrl:null===(A=t.inputs.parameters)||void 0===A?void 0:A.redirectUrl,networkAddress:null===(f=t.inputs.parameters)||void 0===f?void 0:f.gatekeeperNetwork,wallet:t.inputs.parameters.wallet.address,chain:null===(y=t.internal.chainDetails)||void 0===y?void 0:y.chainType,chainNetwork:null===(h=t.internal.chainDetails)||void 0===h?void 0:h.chainNetwork,did:null===(O=t.internal.ownerDids)||void 0===O?void 0:O[0],gatekeeperSendsTransaction:t.inputs.parameters.gatekeeperSendsTransaction,partnerAppId:t.inputs.parameters.partnerAppId,referrer:t.inputs.parameters.referrer,domain:t.inputs.parameters.domain,instanceId:t.internal.instanceId,hideWalletPrompts:t.inputs.parameters.payer&&t.inputs.parameters.payer!==t.inputs.parameters.wallet.address?null===(w=t.inputs.parameters.options)||void 0===w?void 0:w.hideWalletPrompts:void 0,signedTx:null===(g=null===(C=t.internal)||void 0===C?void 0:C.chainTransaction)||void 0===g?void 0:g.sentTxId,civicClient:(null===(G=null===(x=t.inputs)||void 0===x?void 0:x.parameters)||void 0===G?void 0:G.xCivicClientHeader)||Je,stage:null===(m=null===(D=t.inputs)||void 0===D?void 0:D.parameters)||void 0===m?void 0:m.stage})},Be={local:"http://localhost:3004",test:"http://localhost:3004",dev:"https://passv2-dev.civic.com",preprod:"https://passv2-preprod.civic.com",prod:"https://passv2.civic.com"},Ze=function(t,e){var n,r;if(e&&(null===(r=null===(n=t.inputs)||void 0===n?void 0:n.parameters)||void 0===r?void 0:r.stage)){var a=new URL(function(t){var e=Be[t];if(!e)throw new Error("Invalid stage ".concat(t));return e}(t.inputs.parameters.stage)),o=c(e||{}),i=new URLSearchParams(o);return"".concat(a.href,"?").concat(i.toString())}},$e={status:exports.GatewayStatus.UNKNOWN,userInteraction:{status:null},errors:{},ownerDids:[],chainDetails:void 0},tn={flowParameters:void 0,flowState:{status:void 0,userInteraction:{status:null,count:0}},gatewayStatus:exports.GatewayStatus.UNKNOWN,gatewayToken:void 0,gatewayTokenTransaction:void 0,pendingRequests:void 0,ui:void 0},en={civicSign:{status:null,received:null},civicPass:{status:null,received:null},gatewayToken:{status:null,received:null},gatekeeperRecord:{status:null,received:null},parameters:null,dynamicParameters:{forceRequireRefresh:!1},gatekeeperNetworkData:{status:null,received:null}},nn={inputs:en,internal:$e,output:tn},rn=function(t){var e,r,a,o,i,s,u=function(t){return Ye(t)}(t),E=ze(t,u)||void 0,d=function(t,e){var n,r,a,o,i,s,u,E,d,c,l,S,p,_,R;if(null===(n=t.internal)||void 0===n?void 0:n.userInteraction){var T=t.internal.status;return T===exports.GatewayStatus.CHECKING&&xe.includes(e)||T!==exports.GatewayStatus.CHECKING&&Ge.includes(e)&&!Ge.includes(T)||T===exports.GatewayStatus.ACTIVE&&(null===(a=null===(r=t.inputs)||void 0===r?void 0:r.dynamicParameters)||void 0===a?void 0:a.forceRequireRefresh)?"hidden"===(null===(s=null===(i=null===(o=t.inputs.gatekeeperNetworkData)||void 0===o?void 0:o.received)||void 0===i?void 0:i.client)||void 0===s?void 0:s.tokenActiveDisplay)?exports.FlowStatus.FINISHED:exports.FlowStatus.RESULT:(null===(u=t.internal)||void 0===u?void 0:u.userInteraction.status)===rt.FINISHED||T===exports.GatewayStatus.ACTIVE&&"hidden"===(null===(c=null===(d=null===(E=t.inputs.gatekeeperNetworkData)||void 0===E?void 0:E.received)||void 0===d?void 0:d.client)||void 0===c?void 0:c.tokenActiveDisplay)&&null===(null===(S=null===(l=t.internal)||void 0===l?void 0:l.userInteraction)||void 0===S?void 0:S.status)||e===exports.ExtendedGatewayStatus.USER_VALIDATION_FAILED?exports.FlowStatus.FINISHED:(null===(p=t.internal)||void 0===p?void 0:p.userInteraction.status)===rt.STARTED?exports.FlowStatus.IN_PROGRESS:null===(R=null===(_=t.output)||void 0===_?void 0:_.flowState)||void 0===R?void 0:R.status}}(t,u),c=n(n({},null===(e=t.output)||void 0===e?void 0:e.ui),function(t,e,r){var a,o,i,s,u,E,d,c,l,S,p=null===(a=t.inputs.parameters)||void 0===a?void 0:a.options,_=!!(null===(i=null===(o=t.output)||void 0===o?void 0:o.ui)||void 0===i?void 0:i.isVisible);e===exports.FlowStatus.FINISHED||(null===(u=null===(s=t.internal)||void 0===s?void 0:s.userInteraction)||void 0===u?void 0:u.status)===rt.FINISHED?_=!1:(null===(d=null===(E=t.internal)||void 0===E?void 0:E.userInteraction)||void 0===d?void 0:d.status)!==rt.STARTED&&e!==exports.FlowStatus.IN_PROGRESS||(_=!0),e===exports.FlowStatus.RESULT&&(null==p?void 0:p.autoShowModal)&&(_=!0);var R=Ze(t,r),T=(null===(l=null===(c=t.output)||void 0===c?void 0:c.ui)||void 0===l?void 0:l.url)!==R;return n(n({},null===(S=t.output)||void 0===S?void 0:S.ui),{isLoading:T,url:R,isVisible:!!_})}(t,d,E)),l=[exports.FlowStatus.RESULT,exports.FlowStatus.FINISHED].includes(d)&&"hidden"===(null===(o=null===(a=null===(r=t.inputs.gatekeeperNetworkData)||void 0===r?void 0:r.received)||void 0===a?void 0:a.client)||void 0===o?void 0:o.tokenActiveDisplay)?null:t.internal.userInteraction.status;return{internal:n(n({},t.internal),{status:u,userInteraction:n(n({},t.internal.userInteraction),{status:l})}),output:n(n({},t.output),{ui:c,flowParameters:E,flowState:{status:d,userInteraction:n(n({},t.internal.userInteraction),{status:l})},gatewayStatus:Ce(u),gatewayToken:t.inputs.gatewayToken.received||void 0,gatewayTokenTransaction:null===(s=null===(i=t.inputs.gatekeeperRecord)||void 0===i?void 0:i.received)||void 0===s?void 0:s.transaction,pendingRequests:me(t.inputs.gatekeeperRecord)})}},an=function(t){return e=function(t){return function(e){return ve(Oe(_e(Ne(e,t))))}}(t)((function(t,e){return n(n(n({},nn),{functions:{reset:function(){return t(pe((function(t){var e;t.inputs=n(n({},en),{dynamicParameters:t.inputs.dynamicParameters,parameters:t.inputs.parameters}),t.internal=n(n({},$e),{userInteraction:{status:t.internal.userInteraction.status},instanceId:t.internal.instanceId,ownerDids:[],chainDetails:t.internal.chainDetails}),t.output=n(n({},tn),{ui:null===(e=t.output)||void 0===e?void 0:e.ui})})))}}}),((r={})[fe]=rn,r));var r})),e?ht(e):ht;var e},on={isVisible:!1,isLoading:!1,url:void 0,isLoaded:!1},sn=function(){function t(t){this.gatewayCoreStore=t,this.log=y("UIManager")}return t.prototype.onShow=function(){this.log.debug("onShow"),this.gatewayCoreStore.setState((function(t){var e;t.output=t.output||{gatewayStatus:exports.GatewayStatus.UNKNOWN},t.output.ui=(null===(e=t.output)||void 0===e?void 0:e.ui)||n({},on),t.output.ui.isVisible=!0,t.internal.userInteraction.status=rt.STARTED}))},t.prototype.onHide=function(){this.log.debug("onHide"),this.gatewayCoreStore.setState((function(t){var e;t.output=t.output||{gatewayStatus:exports.GatewayStatus.UNKNOWN},t.output.ui=(null===(e=t.output)||void 0===e?void 0:e.ui)||n({},on),t.output.ui.isVisible=!1,t.internal.userInteraction.status=rt.FINISHED}))},t.prototype.onLoad=function(){this.log.debug("onLoad"),this.gatewayCoreStore.setState((function(t){var e;t.output=t.output||{gatewayStatus:exports.GatewayStatus.UNKNOWN},t.output.ui=(null===(e=t.output)||void 0===e?void 0:e.ui)||n({},on),t.output.ui.isLoading=!1,t.output.ui.isLoaded=!0}))},t}(),un={"@@functional/placeholder":!0};function En(t){return t===un}function dn(t){return function e(n){return 0===arguments.length||En(n)?e:t.apply(this,arguments)}}function cn(t){return function e(n,r){switch(arguments.length){case 0:return e;case 1:return En(n)?e:dn((function(e){return t(n,e)}));default:return En(n)&&En(r)?e:En(n)?dn((function(e){return t(e,r)})):En(r)?dn((function(e){return t(n,e)})):t(n,r)}}}function ln(t){for(var e,n=[];!(e=t.next()).done;)n.push(e.value);return n}function Sn(t,e,n){for(var r=0,a=n.length;r<a;){if(t(e,n[r]))return!0;r+=1}return!1}function pn(t,e){return Object.prototype.hasOwnProperty.call(e,t)}var _n="function"==typeof Object.is?Object.is:function(t,e){return t===e?0!==t||1/t==1/e:t!=t&&e!=e},Rn=Object.prototype.toString,Tn=function(){return"[object Arguments]"===Rn.call(arguments)?function(t){return"[object Arguments]"===Rn.call(t)}:function(t){return pn("callee",t)}}(),Nn=!{toString:null}.propertyIsEnumerable("toString"),In=["constructor","valueOf","isPrototypeOf","toString","propertyIsEnumerable","hasOwnProperty","toLocaleString"],vn=function(){return arguments.propertyIsEnumerable("length")}(),An=function(t,e){for(var n=0;n<t.length;){if(t[n]===e)return!0;n+=1}return!1},fn="function"!=typeof Object.keys||vn?dn((function(t){if(Object(t)!==t)return[];var e,n,r=[],a=vn&&Tn(t);for(e in t)!pn(e,t)||a&&"length"===e||(r[r.length]=e);if(Nn)for(n=In.length-1;n>=0;)pn(e=In[n],t)&&!An(r,e)&&(r[r.length]=e),n-=1;return r})):dn((function(t){return Object(t)!==t?[]:Object.keys(t)})),yn=dn((function(t){return null===t?"Null":void 0===t?"Undefined":Object.prototype.toString.call(t).slice(8,-1)}));function hn(t,e,n,r){var a=ln(t);function o(t,e){return On(t,e,n.slice(),r.slice())}return!Sn((function(t,e){return!Sn(o,e,t)}),ln(e),a)}function On(t,e,n,r){if(_n(t,e))return!0;var a,o,i=yn(t);if(i!==yn(e))return!1;if("function"==typeof t["fantasy-land/equals"]||"function"==typeof e["fantasy-land/equals"])return"function"==typeof t["fantasy-land/equals"]&&t["fantasy-land/equals"](e)&&"function"==typeof e["fantasy-land/equals"]&&e["fantasy-land/equals"](t);if("function"==typeof t.equals||"function"==typeof e.equals)return"function"==typeof t.equals&&t.equals(e)&&"function"==typeof e.equals&&e.equals(t);switch(i){case"Arguments":case"Array":case"Object":if("function"==typeof t.constructor&&"Promise"===(a=t.constructor,null==(o=String(a).match(/^function (\w*)/))?"":o[1]))return t===e;break;case"Boolean":case"Number":case"String":if(typeof t!=typeof e||!_n(t.valueOf(),e.valueOf()))return!1;break;case"Date":if(!_n(t.valueOf(),e.valueOf()))return!1;break;case"Error":return t.name===e.name&&t.message===e.message;case"RegExp":if(t.source!==e.source||t.global!==e.global||t.ignoreCase!==e.ignoreCase||t.multiline!==e.multiline||t.sticky!==e.sticky||t.unicode!==e.unicode)return!1}for(var s=n.length-1;s>=0;){if(n[s]===t)return r[s]===e;s-=1}switch(i){case"Map":return t.size===e.size&&hn(t.entries(),e.entries(),n.concat([t]),r.concat([e]));case"Set":return t.size===e.size&&hn(t.values(),e.values(),n.concat([t]),r.concat([e]));case"Arguments":case"Array":case"Object":case"Boolean":case"Number":case"String":case"Date":case"Error":case"RegExp":case"Int8Array":case"Uint8Array":case"Uint8ClampedArray":case"Int16Array":case"Uint16Array":case"Int32Array":case"Uint32Array":case"Float32Array":case"Float64Array":case"ArrayBuffer":break;default:return!1}var u=fn(t);if(u.length!==fn(e).length)return!1;var E=n.concat([t]),d=r.concat([e]);for(s=u.length-1;s>=0;){var c=u[s];if(!pn(c,e)||!On(e[c],t[c],E,d))return!1;s-=1}return!0}var wn=cn((function(t,e){return On(t,e,[],[])}));function Cn(t,e,n){if(n||(n=new gn),function(t){var e=typeof t;return null==t||"object"!=e&&"function"!=e}(t))return t;var r,a=function(r){var a=n.get(t);if(a)return a;for(var o in n.set(t,r),t)Object.prototype.hasOwnProperty.call(t,o)&&(r[o]=e?Cn(t[o],!0,n):t[o]);return r};switch(yn(t)){case"Object":return a(Object.create(Object.getPrototypeOf(t)));case"Array":return a(Array(t.length));case"Date":return new Date(t.valueOf());case"RegExp":return r=t,new RegExp(r.source,r.flags?r.flags:(r.global?"g":"")+(r.ignoreCase?"i":"")+(r.multiline?"m":"")+(r.sticky?"y":"")+(r.unicode?"u":"")+(r.dotAll?"s":""));case"Int8Array":case"Uint8Array":case"Uint8ClampedArray":case"Int16Array":case"Uint16Array":case"Int32Array":case"Uint32Array":case"Float32Array":case"Float64Array":case"BigInt64Array":case"BigUint64Array":return t.slice();default:return t}}var gn=function(){function t(){this.map={},this.length=0}return t.prototype.set=function(t,e){var n=this.hash(t),r=this.map[n];r||(this.map[n]=r=[]),r.push([t,e]),this.length+=1},t.prototype.hash=function(t){var e=[];for(var n in t)e.push(Object.prototype.toString.call(t[n]));return e.join()},t.prototype.get=function(t){if(this.length<=180)for(var e in this.map)for(var n=this.map[e],r=0;r<n.length;r+=1){if((o=n[r])[0]===t)return o[1]}else{var a=this.hash(t);if(n=this.map[a])for(r=0;r<n.length;r+=1){var o;if((o=n[r])[0]===t)return o[1]}}},t}(),xn=dn((function(t){return null!=t&&"function"==typeof t.clone?t.clone():Cn(t,!0)})),Gn=function(t){var e;return t?n(n({},t.parameters),null===(e=t.chainImplementation)||void 0===e?void 0:e.chainDetails):{}},Dn=function(t,e){return!e||!wn(Gn(e.inputs),Gn(t))},mn=function(t){var e;return!(!(null===(e=t.parameters.wallet)||void 0===e?void 0:e.address)||!t.chainImplementation)},Un=function(t,e){var n,r,a,o,i,s,u,E;return"gcc_".concat(null===(r=null===(n=t.parameters.wallet)||void 0===n?void 0:n.address)||void 0===r?void 0:r.substring(0,4),"_").concat(null===(o=null===(a=t.parameters)||void 0===a?void 0:a.gatekeeperNetwork)||void 0===o?void 0:o.substring(0,4),"_").concat(null===(s=null===(i=t.chainImplementation)||void 0===i?void 0:i.chainDetails)||void 0===s?void 0:s.chainType,"_").concat(null===(E=null===(u=t.chainImplementation)||void 0===u?void 0:u.chainDetails)||void 0===E?void 0:E.chainNetwork,"_").concat(e.substring(0,4))},bn=function(){function t(t){var e,r,a,o,i=this;this.inputs=t,this.instanceId=tt(),this.log=y("Core instance: ".concat(this.instanceId)),null===(r=null===(e=this.log)||void 0===e?void 0:e.setLogLevel)||void 0===r||r.call(e,(null===(o=null===(a=t.parameters)||void 0===a?void 0:a.options)||void 0===o?void 0:o.logLevel)||_),this.log.info("GatewayClientCore created",{inputs:t}),this.gatewayCoreStore=an({name:Un(t,this.instanceId),store:"gateway-client-core"}),this.log.info("GatewayClientCore gatewayCoreStore created",this.gatewayCoreStore),this.gatewayCoreStore.subscribe((function(t){return t.output}),(function(e){i.log.debug("GatewayClientCore output changed",e),t.onOutputChange(xn(e))})),this.orchestratorInst=new yt(this.gatewayCoreStore,t.messageEventInterface,this.instanceId,t.parameters,t.fetchConfig,t.postMessageTargetCallback,t.chainImplementation),this.gatewayCoreStore.setState((function(e){e.inputs.parameters=xn(n(n({},t.parameters),{payer:at(t.parameters)})),e.internal.chainDetails=xn(t.chainImplementation.chainDetails),e.inputs.dynamicParameters=xn(t.dynamicParameters),e.internal.instanceId=i.instanceId})),this.orchestratorInst.orchestrate(),this.orchestratorInst.initialise(),this.uiInst=new sn(this.gatewayCoreStore)}return t.getSingleInstance=function(e){var n,r,a=y("GatewayClientCore.getSingleInstance");return mn(e)?(Dn(e,t.currentInstance)&&(a.debug("Inputs have changed, aborting previous and creating a new instance",e),null===(r=t.currentInstance)||void 0===r||r.abort(),t.currentInstance=new t(e)),t.currentInstance):(a.debug("Missing wallet address or chain implementation, aborting previous and setting to undefined",e),null===(n=t.currentInstance)||void 0===n||n.abort(),void(t.currentInstance=void 0))},t.prototype.updateDynamicParameters=function(t){this.gatewayCoreStore.setState((function(e){e.internal.userInteraction.status=null,e.inputs.dynamicParameters=xn(t)}))},t.prototype.updateGatekeeperNetworkServiceData=function(t){this.gatewayCoreStore.setState((function(e){e.inputs.gatekeeperNetworkData=xn(t)}))},t.prototype.startOrResumeFlow=function(){this.gatewayCoreStore.setState((function(t){t.internal.userInteraction.status=rt.STARTED}))},t.prototype.abort=function(){this.log.info("GatewayClientCore aborting"),this.orchestratorInst.abort()},Object.defineProperty(t.prototype,"ui",{get:function(){var t=this;return{onShow:function(){return t.uiInst.onShow()},onHide:function(){return t.uiInst.onHide()},onLoad:function(){return t.uiInst.onLoad()}}},enumerable:!1,configurable:!0}),t}(),Pn={local:null,test:null,dev:"https://dev.api.civic.com/analytics-dev/events",preprod:"https://dev.api.civic.com/analytics-preprod/events",prod:"https://api.civic.com/analytics/events"},Fn=function(t,e,o){return r(void 0,void 0,void 0,(function(){var r,i,s;return a(this,(function(a){switch(a.label){case 0:return(r=Pn[t])?(i=e.civicClient||Je,s=n(n({},e),{source:"passApi_".concat(t),civicClient:i}),o?(N.debug("Beacon API supported. Using it to send analytics event.",{event:e}),o(r,JSON.stringify(s)),N.debug("Analytics event sent.",{eventWithSource:s}),[3,3]):[3,1]):(N.warn("No analytics endpoint configured for stage ".concat(t,".")),[2]);case 1:return N.debug("Beacon API not supported. Falling back to fetch.",{eventWithSource:s}),[4,fetch(r,{method:"POST",mode:"no-cors",body:JSON.stringify(s)})];case 2:a.sent(),a.label=3;case 3:return[2]}}))}))};exports.ChainError=L,exports.ErrorCode=k,exports.GKN_SERVICE_ENDPOINTS=V,exports.GatekeeperClient=b,exports.default=bn,exports.getGatekeeperEndpoint=m,exports.getGatekeeperNetworkData=K,exports.getInstanceInputObject=Gn,exports.hasRequiredInputs=mn,exports.logger=N,exports.prefixLogger=y,exports.sendAnalyticsEvent=Fn,exports.sendOnCloseAnalyticsEvent=function(t,e,n){return r(void 0,void 0,void 0,(function(){var r;return a(this,(function(a){switch(a.label){case 0:return e?(N.debug("Abort received while tx is still pending on the chainImplementation. Sending analytics event."),r={did:t.did||"",networkAddress:t.networkAddress||"",chain:t.chain||"",chainNetwork:t.chainNetwork||"",ownerSigns:t.ownerSigns?"true":"false",wallet:t.wallet||"",domain:t.domain||"",referrer:t.referrer||"",action:"CHAIN_ERROR",errorCode:k.BROWSER_CLOSED_WHILE_TRANSACTION_PENDING,flowId:t.flowId||"",flowType:t.flowType||"",signedTx:e,civicClient:t.civicClient},t.stage?[4,Fn(t.stage,r,n)]:(N.error("Unknown stage. Cannot send analytics event"),[2])):[3,2];case 1:return a.sent(),[3,3];case 2:N.debug("No pending tx in abort analytics handler. Not sending event."),a.label=3;case 3:return[2]}}))}))},exports.shouldUpdateInstance=Dn;
//# sourceMappingURL=civic-gateway-client-core.min.js.map
