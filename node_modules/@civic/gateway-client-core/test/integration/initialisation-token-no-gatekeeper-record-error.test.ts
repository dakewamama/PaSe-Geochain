import { step } from 'mocha-steps';
import sinon from 'sinon';
import chai from 'chai';
import chaiSubset from 'chai-subset';
import chaiAsPromised from 'chai-as-promised';
import sinonChai from 'sinon-chai';
import { IntegrationTestHelpers, sleep } from '../testSupport';
import { ErrorCode } from '../../src';

chai.use(sinonChai);
chai.use(chaiSubset);
chai.use(chaiAsPromised);

const sandbox = sinon.createSandbox();

describe('GatewayClientCore token found on-chain with no gatekeeper-api record integration tests', () => {
  let testHelpers: IntegrationTestHelpers;
  before(() => {
    testHelpers = new IntegrationTestHelpers(sandbox);
    testHelpers.stubSuccessfulFetchCalls();
    testHelpers.stubFindToken({
      expiryTime: 1682891700,
    });
  });

  step('1. expect the Gatekeeper client to successfully initialize', () => {
    testHelpers.initializeGatewayCore({ disableInitialGatekeeperLookup: false });
  });

  step('2. expect the Gatekeeper client to successfully initialize', async () => {
    await sleep(200);
    testHelpers.expectError(ErrorCode.EXPECTED_GATEKEEPER_RECORD);
  });
});
