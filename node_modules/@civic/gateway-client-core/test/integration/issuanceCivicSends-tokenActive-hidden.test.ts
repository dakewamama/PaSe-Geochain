import { step } from 'mocha-steps';
import sinon from 'sinon';
import chai from 'chai';
import chaiSubset from 'chai-subset';
import chaiAsPromised from 'chai-as-promised';
import sinonChai from 'sinon-chai';
import { IntegrationTestHelpers, sleep } from '../testSupport';
import { InputStatus } from '../../src/types/fetch';

chai.use(sinonChai);
chai.use(chaiSubset);
chai.use(chaiAsPromised);

const sandbox = sinon.createSandbox();

describe('GatewayClientCore issuance Civic sends integration tests with hidden TokenActive screen', () => {
  let testHelpers: IntegrationTestHelpers;
  before(() => {
    testHelpers = new IntegrationTestHelpers(sandbox, { clientSends: false });
    testHelpers.stubSuccessfulFetchCalls({ postResponsePayload: { transaction: undefined }, payer: null });
  });

  after(() => {
    testHelpers.cleanup();
    sandbox.restore();
  });

  afterEach(() => {
    testHelpers.expectFlowIdToBeSet('GWRC_issuance_');
  });

  step('1. expect the Gatekeeper client to successfully initialize', async () => {
    testHelpers.initializeGatewayCore();
    // wait for GK and on-chain checks to complete
    await sleep(110);
  });

  step('2. Expect gateway status to change to NOT_REQUESTED', async () => {
    testHelpers.expectNotRequested();
  });

  step('3. Expect successful civic-sign public-key, did and POWO flows', async () => {
    await testHelpers.expectSuccessfulCivicSignProofFlow();
  });

  step('4. Emit a civic-pass event to initiate the GK-API issuance request', async () => {
    await testHelpers.simulateSucessfulDataCollectionTriggeringGKTokenRequest();
  });

  step('5. Expect token in review', () => {
    testHelpers.expectCivicSendsInReview();
  });

  step(
    '6. OnChain listener fires with active token, gateway status and gateway token are updated to active, and tokenActive screen is hidden',
    async () => {
      testHelpers.updateGknData({
        status: InputStatus.COMPLETE,
        received: {
          id: 'validId',
          chains: {
            ethereum: {
              chainSpecificId: '123',
            },
          },
          client: {
            tokenActiveDisplay: 'hidden',
          },
        },
      });
      await testHelpers.simulateActiveOnChainToken();
      testHelpers.expectActiveToken();
      testHelpers.expectTokenActiveScreenHidden();
    }
  );

  step(
    '7.Showing the tokenActive screen should change the flow status to IN_PROGRESS and ui status to visible',
    async () => {
      testHelpers.UiOnShow();
      testHelpers.expectTokenActiveScreenShown();
    }
  );
});
